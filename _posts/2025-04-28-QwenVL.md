---
layout: mypost
title: Qwenå¤šæ¨¡æ€ç³»åˆ—è®ºæ–‡
categories: paper
extMath: true
images: true
address: é•¿æ²™
show_footer_image: true
tags:
- Qwen-vl
- å¤šæ¨¡æ€
- rope
- attention
description: æœ¬æ–‡ä»‹ç»Qwen-vlç³»åˆ—æ¨¡å‹ï¼ŒåŒ…æ‹¬Qwen2-vlä¸Qwen2.5-vlçš„æ ¸å¿ƒæ”¹è¿›ã€‚Qwen2-vlé‡‡ç”¨åŠ¨æ€åˆ†è¾¨ç‡ã€2x2è§†è§‰tokenæ‹¼æ¥åŠå¤šæ¨¡æ€æ—‹è½¬ä½ç½®ç¼–ç ï¼ˆM-RoPEï¼‰ï¼›Qwen2.5-vlä¼˜åŒ–è§†è§‰ç¼–ç å™¨ï¼ˆæ”¹è¿›ViTã€window-attention+full-attentionã€2D-RoPEï¼‰ä¸MLPå¤„ç†ï¼Œå¹¶é€šè¿‡é¢„è®­ç»ƒæ•°æ®ï¼ˆå›¾æ–‡ã€è§†é¢‘ç­‰ï¼‰ã€ç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰åŠç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰æå‡æ€§èƒ½ï¼Œå¼•å…¥åŠ¨æ€FPSä¸ç»å¯¹æ—¶é—´ç¼–ç ä¼˜åŒ–ä½ç½®ç¼–ç ã€‚
---

æœ¬æ–‡ä¸»è¦ä»‹ç»Qwen-vlç³»åˆ—æ¨¡å‹åŒ…æ‹¬ï¼š[Qwen2-vl](#qwen2-vl)ã€[Qwen2.5-vl](#qwen25-vl)

## Qwen2-vl
> http://arxiv.org/abs/2409.12191

æ¨¡å‹ç»“æ„ï¼š
![](https://s2.loli.net/2025/06/21/4TfkDAaULgQP7uw.webp)

**Qwen2-vl**ä¸»è¦çš„æ”¹è¿›ç‚¹åœ¨äºï¼š1ã€ä½¿ç”¨åŠ¨æ€åˆ†è¾¨ç‡ï¼ˆä¹Ÿå°±æ˜¯è¯´è¾“å…¥å›¾åƒä¸éœ€è¦å†å»æ”¹å˜å›¾åƒå°ºå¯¸åˆ°ä¸€ä¸ªå›ºå®šå€¼ï¼‰ï¼Œäºæ­¤åŒæ—¶ä¸ºäº†å‡å°‘ **visual-token**æ•°é‡ï¼Œå°†**2x2çš„çš„ç›¸é‚»çš„tokenè¿›è¡Œæ‹¼æ¥**åˆ°ä¸€ä¸ªtokenè€Œåé€šè¿‡MLPå±‚è¿›è¡Œå¤„ç†ã€‚2ã€ä½¿ç”¨å¤šæ¨¡æ€çš„æ—‹è½¬ä½ç½®ç¼–ç ï¼ˆM-RoPEï¼‰,ä¹Ÿå°±æ˜¯å°†åŸæ¥ä½ç½®ç¼–ç æ‰€æºå¸¦çš„ä¿¡æ¯å¤„ç†ä¸ºï¼šæ—¶åºï¼ˆtemporalï¼‰ã€é«˜åº¦ï¼ˆheightï¼‰ã€å®½åº¦ï¼ˆwidthï¼‰ã€‚æ¯”å¦‚ä¸‹å›¾ä¸­å¯¹äºæ–‡æœ¬å¤„ç†ç›´æ¥åˆå§‹åŒ–ä¸ºï¼š$(i,i,i)$ã€‚ä½†æ˜¯å¯¹äºå›¾ç‰‡è€Œè¨€å°±æ˜¯ï¼š$(i,x,y)$ å…¶ä¸­ $i$ æ˜¯æ’å®šçš„ï¼Œè€Œå¯¹äºè§†é¢‘å°±ä¼šå°† $i$ æ¢æˆè§†é¢‘ä¸­å›¾åƒçš„é¡ºåº

![image.png](https://s2.loli.net/2025/06/21/fIMYhUK6AHVp1Nj.webp)


## Qwen2.5-vl
> http://arxiv.org/abs/2502.13923

æ¨¡å‹ç»“æ„ï¼š
![](https://s2.loli.net/2025/06/21/QUNBjG974sVcgzP.webp)

ä»æ¨¡å‹ç»“æ„ä¸Šè€Œè¨€åœ¨ **Qwen2.5-vl** ä¸­ä¸»è¦æ”¹è¿›ç‚¹åœ¨äºï¼š
* **è§†è§‰ç¼–ç å™¨ä¸Š**

1ã€æ”¹è¿›çš„ViTæ¨¡å‹ï¼ˆwindow-attention+ full-attentionï¼‰ï¼›2ã€2D-RoPE

* **MLPå¤„ç†**

é€šè¿‡ViTå¾—åˆ°æ‰€æœ‰çš„patchä¹‹åï¼Œç›´æ¥å°†è¿™äº›patch**è§£æåˆ†ç»„**ï¼ˆ4ä¸ªä¸€ç»„ï¼‰ç„¶åç»§ç»­æ‹¼æ¥åœ¨è¾“å…¥åˆ°ä¸¤å±‚MLPä¸­è¿›è¡Œå¤„ç†

---

**è¡¥å……1ï¼šwindow-attention**
> https://arxiv.org/abs/2004.05150v2

å‰é¢æœ‰ä»‹ç»åœ¨Kimiå’ŒDeepSeekä¸­å¦‚ä½•å¤„ç†ç¨€ç–æ³¨æ„åŠ›çš„ï¼ˆ[ğŸ”—](https://www.big-yellow-j.top/posts/2025/02/21/Kimi-DS-Paper.html)ï¼‰ï¼Œä»–ä»¬éƒ½æ˜¯é€šè¿‡é¢å¤–çš„ç½‘ç»œç»“æ„æ¥å¤„ç†æ³¨æ„åŠ›è®¡ç®—é—®é¢˜ï¼Œè€Œåœ¨ä¸Šé¢æåˆ°çš„æ³¨æ„åŠ›è®¡ç®—åˆ™æ˜¯ç›´æ¥é€šè¿‡è§„åˆ™èŒƒå¼è®¡ç®—æ³¨æ„åŠ›ã€‚

![](https://s2.loli.net/2025/06/21/c3zeMLOZut2XkWD.webp)

ä¸Šé¢ **window-attention** å¤„ç†èŒƒå¼å°±å’Œå·ç§¯æ“ä½œç±»ä¼¼ï¼Œç›´æ¥é€šè¿‡ç§»åŠ¨â€œæ­¥é•¿â€ç„¶åå¯¹â€œé‡‡é›†â€å¾—åˆ°çš„å†…å®¹è¿›è¡Œè®¡ç®—æ³¨æ„åŠ›ã€‚ä»£ç ï¼š[âš™](../code/WindowAttention.py.txt)ã€‚ä»£ç æ ¸å¿ƒç‚¹å°±åœ¨äºåˆ’åˆ†ï¼Œè€Œåå¯¹åˆ’åˆ†ç»“æœè®¡ç®—æ³¨æ„åŠ›ï¼š

```python
q_window = q[:, :, t:window_end, :]  # (B, num_heads, window_size, head_dim)
k_window = k[:, :, t:window_end, :]
v_window = v[:, :, t:window_end, :]
```

---

ä»‹ç»å®Œè¿™éƒ¨åˆ†æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ä»–æ˜¯å¦‚ä½•å¤„ç†æ•°æ®çš„ï¼ˆæ¯•ç«Ÿè¯´å®åœ¨è¯ï¼Œæ¨¡å‹ï¼ˆæ— è®ºä¸ºLLMè¿˜æ˜¯MLLMåœ¨ç»“æ„ä¸Šåˆ›æ–°è¿œä¸å¦‚æ•°æ®é›†é‡è¦ï¼‰éƒ½æ˜¯æ•°æ®é©±åŠ¨çš„ï¼‰ä»¥åŠä»–æ˜¯å¦‚ä½•è®­ç»ƒæ¨¡å‹çš„ã€‚
* **1ã€æ¨¡å‹é¢„è®­ç»ƒ**
![](https://s2.loli.net/2025/06/21/lG5Xd1Ki9hjDBYR.webp)

ä»è®ºæ–‡é‡Œé¢ä½œè€…æåˆ°å¦‚ä¸‹å‡ ç§æ•°æ®ä»¥åŠå¤„ç†èŒƒå¼å¦‚ä¸‹ï¼š
**1ã€Image-Text Data**ï¼ˆå›¾ç‰‡-æ–‡æœ¬åŒ¹é…æ•°æ®é›†ï¼‰ï¼šä¿ç•™è¾ƒé«˜è¯„åˆ†åŒ¹é…å¯¹ï¼ˆè¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ–‡æœ¬å¯¹äºå›¾ç‰‡æè¿°è¦ä¸°å¯Œï¼‰ã€ä¿¡æ¯äº’è¡¥ï¼ˆå›¾åƒå’Œæ–‡æœ¬å„è‡ªæä¾›ç‹¬ç‰¹ä¿¡æ¯ï¼‰ã€ä¿¡æ¯å¯†åº¦å¹³è¡¡
**2ã€Video Data**ï¼ˆè§†é¢‘æ•°æ®ï¼‰ï¼šé¦–å…ˆæ˜¯é€šè¿‡åŠ¨æ€é‡‡ç”¨æ–¹å¼è·å–è§†é¢‘å¸§ï¼›
**3ã€å›¾åƒåæ ‡åˆ†è¾¨ç‡å¤„ç†**ï¼šç›´æ¥å°†åŸå§‹å›¾åƒè¿›è¡Œè¾“å…¥ä¸å»ä¿®æ”¹åˆ†è¾¨ç‡ï¼ˆå›ºå®šæ¯ä¸ªpatchä¸º112x112å¯¹äºä¸è¶³çš„ä¸å»åšå¡«è¡¥ï¼Œæ€»å…±8x8ä¸ªpatchesï¼‰ï¼Œå¯¹äºé‡Œé¢çš„åæ ‡ç›´æ¥ä½¿ç”¨Grounding DINO æˆ–è€…SAMè¿›è¡Œè·å–ã€‚
**4ã€Omni-Parsing Data**ï¼šå¯¹äºæ–‡æ¡£æ•°æ®é›†ç›´æ¥è§£æä¸ºhtmlæ ¼å¼

* **3ã€æ¨¡å‹åè®­ç»ƒ**

* **1ã€ç›‘ç£å¾®è°ƒ (SFT)**

SFTé˜¶æ®µç”¨åˆ°çš„instruction dataåŒ…å«çº¦ 200 ä¸‡æ¡æ•°æ®ï¼Œ50% ä¸ºçº¯æ–‡æœ¬æ•°æ®ï¼Œ50% ä¸ºå¤šæ¨¡æ€æ•°æ®ï¼ˆå›¾æ–‡å’Œè§†é¢‘æ–‡æœ¬ï¼‰ã€‚åœ¨æ•°æ®è¿‡æ»¤æµç¨‹ä¸­ï¼Œå…ˆä½¿ç”¨ Qwen2-VL-Instag ï¼ˆä¸€ä¸ªåŸºäºQwen2-VLçš„åˆ†ç±»æ¨¡å‹ï¼‰å°† QA å¯¹åˆ†å±‚åˆ†ç±»ä¸º 8 ä¸ªä¸»è¦é¢†åŸŸå’Œ 30 ä¸ªç»†ç²’åº¦å­ç±»åˆ«ï¼Œç„¶åå¯¹äºè¿™äº›ç»†åˆ†ç±»åˆ«ï¼Œä½¿ç”¨é¢†åŸŸå®šåˆ¶è¿‡æ»¤ï¼Œç»“åˆåŸºäºè§„åˆ™å’ŒåŸºäºæ¨¡å‹çš„è¿‡æ»¤æ–¹æ³•ã€‚

åŸºäºè§„åˆ™çš„è¿‡æ»¤: åˆ é™¤é‡å¤æ¨¡å¼ã€ä¸å®Œæ•´æˆ–æ ¼å¼é”™è¯¯çš„æ¡ç›®ï¼Œä»¥åŠä¸ç›¸å…³æˆ–å¯èƒ½å¯¼è‡´æœ‰å®³è¾“å‡ºçš„æŸ¥è¯¢å’Œç­”æ¡ˆã€‚
åŸºäºæ¨¡å‹çš„è¿‡æ»¤: ä½¿ç”¨ Qwen2.5-VL ç³»åˆ—è®­ç»ƒçš„å¥–åŠ±æ¨¡å‹è¯„ä¼°å¤šæ¨¡æ€ QA å¯¹ã€‚
æ­¤å¤–ï¼Œåœ¨è®­ç»ƒä¸­è¿˜ä½¿ç”¨æ‹’ç»é‡‡æ · (Rejection Sampling)æŠ€æœ¯ï¼Œå¢å¼ºæ¨¡å‹çš„æ¨ç†èƒ½åŠ›ã€‚ä½¿ç”¨ä¸€ä¸ªä¸­é—´ç‰ˆæœ¬çš„ Qwen2.5-VL æ¨¡å‹ï¼Œå¯¹å¸¦æœ‰æ ‡æ³¨ï¼ˆground truthï¼‰çš„æ•°æ®é›†ç”Ÿæˆå“åº”ï¼Œå°†æ¨¡å‹ç”Ÿæˆçš„å“åº”ä¸æ ‡æ³¨çš„æ­£ç¡®ç­”æ¡ˆè¿›è¡Œæ¯”è¾ƒï¼Œåªä¿ç•™æ¨¡å‹è¾“å‡ºä¸æ­£ç¡®ç­”æ¡ˆåŒ¹é…çš„æ ·æœ¬ï¼Œä¸¢å¼ƒä¸åŒ¹é…çš„æ ·æœ¬ã€‚æ­¤å¤–è¿˜è¿›ä¸€æ­¥è¿‡æ»¤æ‰ä¸ç†æƒ³çš„è¾“å‡ºï¼Œä¾‹å¦‚ï¼šä»£ç åˆ‡æ¢ (code-switching)ã€è¿‡é•¿ (excessive length)ã€é‡å¤æ¨¡å¼ (repetitive patterns)ç­‰ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç¡®ä¿æ•°æ®é›†ä¸­åªåŒ…å«é«˜è´¨é‡ã€å‡†ç¡®çš„ç¤ºä¾‹ã€‚

è¿™é‡Œä¼šä¸ä¼šå› æ­¤ä¸¢å¼ƒæ‰ä¸€äº›å¥½çš„å›°éš¾æ ·æœ¬ï¼ŸæŠ¥å‘Šä¸­å¹¶æ²¡æœ‰æåŠï¼Œä¼¼ä¹å¯¹äºSFTé˜¶æ®µï¼Œæ­£ç¡®æ€§çš„è¦æ±‚å‹å€’éš¾åº¦ï¼Œå¹¶ä¸æŒ‡æœ›é€šè¿‡è¿™ä¸€é˜¶æ®µè·å¾—æ›´å¼ºçš„èƒ½åŠ›ã€‚

* **2ã€ç›´æ¥åå¥½ä¼˜åŒ– (DPO)**

æŠ¥å‘Šä¸­åŸºæœ¬ä¸€ç¬”å¸¦è¿‡ã€‚ä»…ä½¿ç”¨å›¾æ–‡å’Œçº¯æ–‡æœ¬æ•°æ®ï¼Œä¸ä½¿ç”¨è§†é¢‘æ•°æ®ï¼Œåˆ©ç”¨åå¥½æ•°æ®å°†æ¨¡å‹ä¸äººç±»åå¥½å¯¹é½ã€‚æ²¡æœ‰ä½¿ç”¨GRPOå’ŒåŸºäºè§„åˆ™çš„å¼ºåŒ–å­¦ä¹ ã€‚å¯¹äºæ•°å­¦ã€ä»£ç ä»¥å¤–çš„ä»»åŠ¡ï¼Œä¼¼ä¹æ²¡æœ‰ç‰¹åˆ«å¥½çš„è§„åˆ™å®šä¹‰æ–¹æ³•ï¼Œè¿˜æ˜¯è¦å›åˆ°åŸºäºå¥–åŠ±æ¨¡å‹æˆ–è€…åå¥½æ•°æ®çš„æ–¹æ³•ã€‚

## ä»£ç å¯¹æ¯”

ä¸¤ä¸ªæ¨¡å‹åœ¨ä»£ç ä¸Šå·®å¼‚ï¼š

![](https://s2.loli.net/2025/06/21/boN6fuXmUGdrTJ1.webp)

### 1ã€ViTä»£ç 
å€¼å¾—æ³¨æ„çš„åœ¨ **Qwen2-vl**ä¸­ä½¿ç”¨äº†æ‹¼æ¥æ–¹å¼ï¼Œåœ¨ **Qwen2.5-vl**ä¾æ—§ä½¿ç”¨äº†è¿™ç§æ–¹å¼æ¥å°†Vitå¾—åˆ°çš„tokenè¿›è¡Œå‡å°‘è¿›è€Œå‡å°è®¡ç®—é‡ã€‚é€šè¿‡ **Qwen2.5-vl**æ¥ç†è§£æ¨¡å‹ï¼ˆQwen2.5-vlä¸­vitæ“ä½œï¼Œ[ä»£ç ](https://github.com/huggingface/transformers/blob/a847d4aa6bd2279f5be235dc0fd862f58f7403d1/src/transformers/models/qwen2_5_vl/modeling_qwen2_5_vl.py#L406)ï¼‰,å®˜æ–¹ä»£ç ä¸­åˆ’åˆ†çª—å£è®¾ç½®ï¼š

```python
def get_window_index(self, grid_thw):
    window_index: list = []
    cu_window_seqlens: list = [0]
    window_index_id = 0
    vit_merger_window_size = self.window_size // self.spatial_merge_size // self.patch_size

    for grid_t, grid_h, grid_w in grid_thw:
        #ï¼ˆ1ï¼‰å› ä¸ºä½ç½®ç¼–ç ç»“æ„æ˜¯tã€hã€wï¼ˆå…·ä½“æè¿°è§Qwen2-vlæè¿°ï¼‰
        llm_grid_h, llm_grid_w = (
            grid_h // self.spatial_merge_size, # spatial_merge_sizeï¼šç©ºé—´åˆå¹¶çš„å°ºå¯¸
            grid_w // self.spatial_merge_size,
        )
        index = torch.arange(grid_t * llm_grid_h * llm_grid_w).reshape(grid_t, llm_grid_h, llm_grid_w)

        #ï¼ˆ2ï¼‰è®¡ç®—éœ€è¦çš„padding
        pad_h = vit_merger_window_size - llm_grid_h % vit_merger_window_size
        pad_w = vit_merger_window_size - llm_grid_w % vit_merger_window_size

        #ï¼ˆ3ï¼‰è®¡ç®—paddingåçš„çª—å£æ•°é‡ï¼Œå¹¶ä¸”ç”¨ -100 è¿›è¡Œå¡«è¡¥
        num_windows_h = (llm_grid_h + pad_h) // vit_merger_window_size
        num_windows_w = (llm_grid_w + pad_w) // vit_merger_window_size
        index_padded = F.pad(index, (0, pad_w, 0, pad_h), "constant", -100)
        
        #ï¼ˆ4ï¼‰é‡å¡‘ç´¢å¼•ä¸ºçª—å£å½¢å¼
        index_padded = index_padded.reshape(
            grid_t,
            num_windows_h,
            vit_merger_window_size,
            num_windows_w,
            vit_merger_window_size,
        )
        index_padded = index_padded.permute(0, 1, 3, 2, 4).reshape(
            grid_t,
            num_windows_h * num_windows_w,
            vit_merger_window_size,
            vit_merger_window_size,
        )

        #ï¼ˆ5ï¼‰è®¡ç®—æ¯ä¸ªçª—å£ä¸­æœ‰æ•ˆå…ƒç´ çš„æ•°é‡
        seqlens = (index_padded != -100).sum([2, 3]).reshape(-1)
        index_padded = index_padded.reshape(-1)
        index_new = index_padded[index_padded != -100]
        window_index.append(index_new + window_index_id)
        cu_seqlens_tmp = seqlens.cumsum(0) * self.spatial_merge_unit + cu_window_seqlens[-1]
        # self.spatial_merge_unit = self.spatial_merge_size * self.spatial_merge_size
        cu_window_seqlens.extend(cu_seqlens_tmp.tolist())
        window_index_id += (grid_t * llm_grid_h * llm_grid_w).item()
    # åˆå¹¶æ‰€æœ‰çš„çª—å£ç´¢å¼•
    window_index = torch.cat(window_index, dim=0)
    # window_index: çª—å£ç´¢å¼•ï¼›
    # cu_window_seqlensï¼šæ¯ä¸ªçª—å£çš„é—´éš”
    return window_index, cu_window_seqlens
```
äº‰å¯¹ä¸Šé¢ä»£ç ï¼Œæ¯”å¦‚è¾“å…¥æ•°æ®å½¢çŠ¶ä»¥åŠå‚æ•°ä¸ºï¼š
1ã€`grid_thw:[2,8,8]`ï¼›2ã€`self.window_size = 8`ï¼›3ã€`self.spatial_merge_size=self.patch_size=2`ã€‚é‚£ä¹ˆæ¯ä¸€æ­¥å¾—åˆ°ç»“æœä¸ºï¼š
ï¼ˆ1ï¼‰indexç»“æœä¸ºï¼ˆå› ä¸ºè¦è¿›è¡Œ2x2è¿›è¡Œåˆå¹¶æ“ä½œï¼‰:
```python
index: tensor([[[ 0,  1,  2,  3],
         [ 4,  5,  6,  7],
         [ 8,  9, 10, 11],
         [12, 13, 14, 15]],

        [[16, 17, 18, 19],
         [20, 21, 22, 23],
         [24, 25, 26, 27],
         [28, 29, 30, 31]]])
```

ï¼ˆ3ï¼‰å¾—åˆ°index_paddedä¸ºï¼š
```python
index_padded: tensor([[[   0,    1,    2,    3, -100, -100],
         [   4,    5,    6,    7, -100, -100],
         [   8,    9,   10,   11, -100, -100],
         [  12,   13,   14,   15, -100, -100],
         [-100, -100, -100, -100, -100, -100],
         [-100, -100, -100, -100, -100, -100]],

        [[  16,   17,   18,   19, -100, -100],
         [  20,   21,   22,   23, -100, -100],
         [  24,   25,   26,   27, -100, -100],
         [  28,   29,   30,   31, -100, -100],
         [-100, -100, -100, -100, -100, -100],
         [-100, -100, -100, -100, -100, -100]]])
```

ï¼ˆ5ï¼‰window_sizeåˆå¹¶å¾—åˆ°ç»“æœä¸ºï¼š
```python
window_index:tensor([ 0,  1,  4,  5,  2,  3,  6,  7,  8,  9, 12, 13, 10, 11, 14, 15, 16, 17,
        20, 21, 18, 19, 22, 23, 24, 25, 28, 29, 26, 27, 30, 31])
cu_window_seqlens:[0, 16, 32, 32, 48, 64, 64, 64, 64, 64, 80, 96, 96, 112, 128, 128, 128, 128, 128]
# è¿™é‡Œæœ‰é‡å¤æ•°å€¼ï¼Œåé¢è®¡ç®—ä¼šé€šè¿‡ torch.unique_consecutive å»é™¤å¾—åˆ°ï¼š[  0,  16,  32,  48,  64,  80,  96, 112, 128]
```

ç†è§£ä¸Šé¢è®¡ç®—ç»“æœï¼ˆå¤„ç†æ€è·¯å’Œå·ç§¯ç¥ç»ç½‘ç»œå¾ˆåƒï¼‰ï¼š`window_index`ï¼šå› ä¸ºè¾“å…¥æ˜¯ $[2,8,8]$ ç„¶ååˆ’åˆ†å¤§å°ä¸º2ï¼ˆ`self.spatial_merge_size=self.patch_size=2`ï¼‰å°±åƒæ˜¯â€œå·ç§¯æ ¸â€ä¸€æ ·ã€‚å› æ­¤å¾—åˆ°åºåˆ—é•¿åº¦å°±æ˜¯ï¼š32ï¼ˆä¹Ÿå°±æ˜¯0-31ï¼‰ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªç´¢å¼•ä»£è¡¨å›¾åƒä¸­çš„â€œä¸€å—â€ï¼Œæ¯”å¦‚è¯´ï¼š0ä»£è¡¨å·¦ä¸Šè§’2x2çš„åŒºåŸŸï¼Œ1ï¼šä»£è¡¨0å³è¾¹2x2åŒºåŸŸï¼›`cu_window_seqlens`ï¼šçŸ¥é“æ¯å—åŒºåŸŸç´¢å¼•ä¹‹åè¿˜éœ€è¦çŸ¥é“â€œæ­¥é•¿â€ï¼Œ$0,16$ ä»£è¡¨ç¬¬ä¸€å—å’Œç¬¬äºŒå—ä¹‹é—´é—´éš”ä¸º16é‚£ä¹ˆå°±å¯ä»¥ç¡®å®šæœ‰4å—ï¼ˆ $4\times2\times2$ ï¼‰

å¾—åˆ°window_sizeä¹‹ååœ¨forwardè®¡ç®—ä¸­ï¼š
```python
def forward(self, hidden_states, grid_thw):
    hidden_states = self.patch_embed(hidden_states)
    ...
    window_index, cu_window_seqlens = self.get_window_index(grid_thw)
    ...
    cu_window_seqlens = torch.unique_consecutive(cu_window_seqlens)

    #ï¼ˆ1ï¼‰é‡å¡‘çª—å£åŒ–ç‰¹å¾
    seq_len, _ = hidden_states.size()
    hidden_states = hidden_states.reshape(seq_len // self.spatial_merge_unit, self.spatial_merge_unit, -1)
    # æŒ‰ç…§window_sizeè¿›è¡Œæ’åº
    hidden_states = hidden_states[window_index, :, :]
    hidden_states = hidden_states.reshape(seq_len, -1)
    #ï¼ˆ2ï¼‰é‡å¡‘ä½ç½®ç¼–ç 
    rotary_pos_emb = rotary_pos_emb.reshape(seq_len // self.spatial_merge_unit, self.spatial_merge_unit, -1)
    rotary_pos_emb = rotary_pos_emb[window_index, :, :]
    rotary_pos_emb = rotary_pos_emb.reshape(seq_len, -1)

    emb = torch.cat((rotary_pos_emb, rotary_pos_emb), dim=-1)
    position_embeddings = (emb.cos(), emb.sin())

    #ï¼ˆ3ï¼‰è®¡ç®—åºåˆ—é•¿åº¦
    cu_seqlens = torch.repeat_interleave(grid_thw[:, 1] * grid_thw[:, 2], grid_thw[:, 0]).cumsum(
            dim=0,
            dtype=grid_thw.dtype if torch.jit.is_tracing() else torch.int32,
        )
    cu_seqlens = F.pad(cu_seqlens, (1, 0), value=0)

    #ï¼ˆ4ï¼‰éå†è€Œåè®¡ç®—æ³¨æ„åŠ›
    for layer_num, blk in enumerate(self.blocks):
        if layer_num in self.fullatt_block_indexes:
            cu_seqlens_now = cu_seqlens
        else:
            cu_seqlens_now = cu_window_seqlens
        # è®¡ç®—æ³¨æ„åŠ›
        if self.gradient_checkpointing and self.training:
            hidden_states = self._gradient_checkpointing_func(
                    blk.__call__, hidden_states, cu_seqlens_now, None, position_embeddings
                )
        else:
            hidden_states = blk(hidden_states, cu_seqlens=cu_seqlens_now, position_embeddings=position_embeddings)

        hidden_states =

      hidden_states = self.merger(hidden_states)
      reverse_indices = torch.argsort(window_index)
      hidden_states = hidden_states[reverse_indices, :]

      return hidden_states
```

å…¶ä¸­`self.merger`ä¸ºï¼š
```python
class Qwen2_5_VLPatchMerger(nn.Module):
    def __init__(self, dim: int, context_dim: int, spatial_merge_size: int = 2) -> None:
        super().__init__()
        self.hidden_size = context_dim * (spatial_merge_size**2)
        self.ln_q = Qwen2RMSNorm(context_dim, eps=1e-6)
        self.mlp = nn.Sequential(
            nn.Linear(self.hidden_size, self.hidden_size),
            nn.GELU(),
            nn.Linear(self.hidden_size, dim),
        )

    def forward(self, x: torch.Tensor) -> torch.Tensor:
        x = self.mlp(self.ln_q(x).view(-1, self.hidden_size))
        return x
```

æ€»ç»“ä¸Šé¢ä»£ç è¿‡ç¨‹å¦‚ä¸‹ï¼šé¦–å…ˆæ˜¯å°†å›¾åƒåˆ’åˆ†ä¸ºä¸åŒpatchï¼ˆè¿™é‡Œæ“ä½œå’Œå¸¸è§„çš„Vitæ“ä½œæ²¡æœ‰åŒºåˆ«ï¼‰å¾—åˆ°ç‰¹å¾ `hidden_states`ï¼Œè€Œåå»åˆ’åˆ†ä¸åŒçª—å£ï¼Œè€Œè¿™ä¸ªçª—å£å°±æ˜¯ç›´æ¥å»å¯¹æœ€å¼€å§‹å›¾åƒæ‰€è¿›è¡Œçš„ï¼ˆæ¯”å¦‚è¯´å›¾åƒä¸ºï¼š2x8x8ï¼Œ2ä»£è¡¨æ—¶é—´å¸§ï¼‰ï¼Œé¦–å…ˆè®¡ç®—éœ€è¦åˆå¹¶çš„å—çš„ç´¢å¼•ï¼Œè€Œåå°† `hidden_states` æ ¹æ®è¿™ä¸ªç´¢å¼•è¿›è¡Œæ’åºï¼Œæ’åºä¹‹åå°±éœ€è¦å¯¹è¿™äº›æ’åºå†…å®¹è®¡ç®—æ³¨æ„åŠ›å³å¯ï¼ˆå¾ˆåƒå·ç§¯æ“ä½œï¼šåˆ†å—å°±æ˜¯æˆ‘ä»¬çš„å·ç§¯æ ¸ï¼Œè€Œcu_window_seqlenså°±æ˜¯æˆ‘ä»¬çš„æ­¥é•¿ï¼‰
> `grid_thw:[2,8,8]`ï¼›2ã€`self.window_size = 8`ï¼›3ã€`self.spatial_merge_size=self.patch_size=2`


### 2ã€ä½ç½®ç¼–ç 

åœ¨Qwen2-VLä¸­ï¼Œæ—¶é—´æ–¹å‘æ¯å¸§ä¹‹é—´å›ºå®šé—´éš” 1 ï¼Œæ²¡æœ‰è€ƒè™‘åˆ°è§†é¢‘çš„é‡‡æ ·ç‡ï¼Œä¾‹å¦‚å››ç§’çš„è§†é¢‘æ¯ç§’é‡‡æ ·ä¸¤å¸§å’Œä¸€ç§’çš„è§†é¢‘æ¯ç§’é‡‡æ ·å…«å¸§ï¼Œè¿™æ ·æ€»çš„å¸§æ•°éƒ½æ˜¯8ï¼Œåœ¨åŸæ¥è¿™ç§ç¼–ç æ–¹å¼ä¸­æ—¶é—´ç»´åº¦çš„ç¼–ç éƒ½æ˜¯1->8æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚Qwen-2.5VLåœ¨æ—¶é—´ç»´åº¦ä¸Šå¼•å…¥äº†åŠ¨æ€ FPS (æ¯ç§’å¸§æ•°)è®­ç»ƒå’Œç»å¯¹æ—¶é—´ç¼–ç ï¼Œå°† mRoPE id ç›´æ¥ä¸æ—¶é—´æµé€Ÿå¯¹é½ã€‚æè¿°åŸç†è§ï¼šhttps://spaces.ac.cn/archives/10040

## å‚è€ƒ
1ã€https://arxiv.org/abs/2004.05150v2
2ã€http://arxiv.org/abs/2309.16609
3ã€http://arxiv.org/abs/2409.12191
4ã€http://arxiv.org/abs/2502.13923
5ã€https://zhuanlan.zhihu.com/p/24986805514
6ã€https://qwenlm.github.io/zh/blog/qwen2.5-vl/
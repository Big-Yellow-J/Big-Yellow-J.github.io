---
layout: mypost
title: å¼ºåŒ–å­¦ä¹ æ¡†æ¶ï¼šOpenRLHFæºç è§£è¯»ï¼Œæ¨¡å‹è®­ç»ƒ
categories: OpenRLHFæ¡†æ¶è§£è¯»
address: changsha
extMath: true
show_footer_image: true
description: å¼ºåŒ–å­¦ä¹ æ¡†æ¶ï¼šOpenRLHFæºç è§£è¯»ï¼Œæ¨¡å‹è®­ç»ƒæ¨¡å—è§£è¯»
---

å‰æ–‡å·²ç»ä»‹ç»äº†ï¼š
* [**å¼ºåŒ–å­¦ä¹ æ¡†æ¶ï¼šOpenRLHFæºç è§£è¯»ï¼Œæ¨¡å‹å¤„ç†æ¨¡å—è§£è¯»**](https://www.big-yellow-j.top/posts/2025/04/22/OpenRLHF-1.html)

æœ¬æ–‡ä¸»è¦ä»‹ç» **å¼ºåŒ–å­¦ä¹ æ¡†æ¶ï¼šOpenRLHFæºç è§£è¯»ï¼Œæ¨¡å‹**ã€‚å› ä¸ºRLç”±DPOã€GRPOã€PPOç­‰å‡ ç§ç±»åˆ«ï¼Œå› æ­¤æœ¬æ–‡ä½å“Ÿä»‹ç»PPOèŒƒå¼è®­ç»ƒã€‚åœ¨OpenRLHFè®­ç»ƒæ¡†æ¶ä¸­ï¼Œä¸»è¦è¿˜ä¼šåº”ç”¨åˆ°DeepSpeedä»¥åŠvLLMï¼Œå› æ­¤åœ¨ä»‹ç»PPOè®­ç»ƒä¹‹å‰éœ€è¦å›é¡¾ä¸€ä¸‹ï¼š**1ã€DeepSpeedçš„é…ç½®**ï¼›**2ã€vLLMé…ç½®**ã€‚
> åœ¨ä¹‹å‰Blogå·²ç»å¯¹[DeepSpeed](https://www.big-yellow-j.top/posts/2025/02/24/deepspeed.html)ä»¥åŠ[vLLM](https://www.big-yellow-j.top/posts/2025/02/17/Attention.html)åŸç†è¿›è¡Œäº†è§£é‡Šï¼Œå› æ­¤åªéœ€è¦ä»‹ç»åœ¨OpenRLHFå¦‚ä½•å»å¯¹è¿™ä¸¤éƒ¨åˆ†è¿›è¡Œé…ç½®

å‚æ•°å‚è€ƒè„šæœ¬ï¼šhttps://github.com/OpenRLHF/OpenRLHF/blob/main/examples/scripts/train_ppo_llama_ray.sh ä¸­çš„è®¾ç½®
* **1ã€vLLMé…ç½®**

> From:https://github.com/OpenRLHF/OpenRLHF/blob/main/openrlhf/trainer/ray/vllm_engine.py

```python
def create_vllm_engines(
    num_engines: int, # æ¨ç†å¼•æ“æ•°é‡
    tensor_parallel_size: int, # å¼ é‡å¹¶è¡Œå¤§å°
    pretrain: str,
    seed: int,
    full_determinism: bool,
    enable_prefix_caching: bool,
    enforce_eager: bool,
    max_model_len: int,
    num_total_actors: int,
    shared_pg=None,
    gpu_memory_utilization=None,
    vllm_enable_sleep=False,):
    ...
    # 1ã€èµ„æºè°ƒåº¦é…ç½®ã€‚é…ç½®å‚æ•°è®¾ç½®ä¸ºï¼šnum_engines= tensor_parallel_size= 2
    use_hybrid_engine = shared_pg is not None
    num_gpus = int(tensor_parallel_size == 1)
    if use_hybrid_engine and tensor_parallel_size == 1:
        num_gpus = 0.2

    if not use_hybrid_engine:
        bundles = [{"GPU": 1, "CPU": 1} for _ in range(num_engines * tensor_parallel_size)]
        shared_pg = placement_group(bundles, strategy="PACK")
        ray.get(shared_pg.ready())
    ...
    # 2ã€æ„å»ºæ¯ä¸€ä¸ªvLLMï¼ˆ=2ï¼‰
    for i in range(num_engins):
        ...
        scheduling_strategy = PlacementGroupSchedulingStrategy(...) # è°ƒåº¦ç­–ç•¥
        ...
        vllm_engines.append(
            LLMRayActor.options(
            num_cpus=num_gpus,
            num_gpus=num_gpus,
            scheduling_strategy=scheduling_strategy,
        ).remote(...)
        )
```

1ã€**èµ„æºè°ƒåº¦é…ç½®**ï¼šç¬¬ä¸€ç§Hybridæ¨¡å¼ï¼ˆå¤šä¸ªå¼•æ“å…±åŒå ç”¨GPUï¼‰ï¼›ç¬¬äºŒç§æ ‡å‡†æ¨¡å¼ï¼ˆæ¯ä¸ªå¼•æ“éƒ½å•ç‹¬å ç”¨ä¸€ä¸ªGPUå’ŒCPUï¼‰ï¼›
2ã€**æ„å»ºvLLM**ï¼šé¦–å…ˆæ˜¯å»ºç«‹èµ„æºè°ƒåº¦ç­–ç•¥ï¼Œä»¥åŠä½¿ç”¨vLLMã€‚æœ‰å¿…è¦äº†è§£ä¸€ä¸‹å°±æ˜¯åœ¨OpenRLHFä¸­ä½¿ç”¨çš„æ˜¯ [**ray**](https://www.ray.io/) åˆ†å¸ƒå¼æ¶æ„è¿›è¡Œè®­ç»ƒã€‚ç®€å•äº†è§£ä¸€ä¸‹åœ¨è¿™ä¸ªé‡Œé¢ä»–æ˜¯æ€ä¹ˆåšçš„ã€‚é€šè¿‡ rayå°è£…äº†ä¸€ä¸ªvLLMæ¨ç†æ¶æ„ï¼ˆè¿‡ç¨‹å’Œpythonä¸­å¤šè¿›ç¨‹å¾ˆç›¸åƒï¼‰

> **è¡¥å……-1**ï¼šrayç®€å•ä½¿ç”¨ï¼Œä»£ç ï¼š[ğŸ”—](../code/ray_test.py.txt)
> Rayæ ¸å¿ƒæ¦‚å¿µï¼š1ã€ä»»åŠ¡ï¼ˆTaskï¼‰ï¼šæ— çŠ¶æ€çš„å¹¶è¡Œå‡½æ•°è°ƒç”¨ã€‚
2ã€Actorï¼šæœ‰çŠ¶æ€çš„è®¡ç®—å•å…ƒï¼Œé€‚åˆéœ€è¦æŒä¹…çŠ¶æ€çš„åœºæ™¯ï¼ˆå¦‚æ¨¡å‹æ¨ç†ï¼‰ã€‚3ã€è¿œç¨‹è°ƒç”¨ï¼ˆremoteï¼‰ï¼šé€šè¿‡ .remote() å¼‚æ­¥è°ƒåº¦ä»»åŠ¡æˆ– Actor æ–¹æ³•ã€‚æ¯”å¦‚è¯´ä¸Šé¢ä»£ç ï¼Œåˆå§‹åŒ–æˆ‘éœ€è¦çš„èŠ‚ç‚¹ 
```python
@ray.remote
class PrintActor:
```
> åœ¨vLLMä¸­å¯èƒ½å°±éœ€è¦å¯¹èµ„æºè¿›è¡Œåˆ†é…ï¼š`PrintActor.options(...).remote(...)`å…¶ä¸­ `remote`å°±æ˜¯æ¯ä¸ªâ€œè¿›ç¨‹â€éœ€è¦è¾“å‡ºçš„ä»»åŠ¡å‚æ•°ï¼Œè€Œ `options` åˆ™æ˜¯èµ„æºåˆ†é…ç­–ç•¥ï¼Œæ¯”å¦‚GPUï¼ˆ`num_gpus`ï¼‰/CPUï¼ˆ`num_cpus`ï¼‰æ•°é‡ã€‚åœ¨åé¢è·å–è¿›ç¨‹ç»“æœå¯ä»¥ç›´æ¥é€šè¿‡ï¼š
```python
ray.init()
print_engines = create_print_engines(4)
results = [engine.execture_print.remote(i) for i, engine in enumerate(print_engines)]
print(ray.get(results))
```

## PPOè®­ç»ƒèŒƒå¼

å®Œå…¨äº†è§£PPOè®­ç»ƒèŒƒå¼ä¹‹å‰éœ€è¦äº†è§£ä¸€ä¸‹åœ¨OpenRLHFä¸­å¦‚ä½•å®šä¹‰ PPOè®­ç»ƒå™¨çš„ã€‚

* 1ã€`ActorPPOTrainer`



### train.sh

æ¨¡å‹è®­ç»ƒè„šæœ¬ï¼š[ğŸ”—](https://github.com/OpenRLHF/OpenRLHF/blob/main/examples/scripts/train_ppo_llama_ray.sh) è„šæœ¬ä¸­ä¸»è¦æ¶‰åŠåˆ°å‚æ•°ï¼š1ã€æ¨¡å‹è„šæœ¬ï¼š`openrlhf.cli.train_ppo_ray`ï¼›2ã€

### `train_ppo_ray.py`
> From: https://github.com/OpenRLHF/OpenRLHF/blob/main/openrlhf/cli/train_ppo_ray.py

å‰é¢å·²ç»ä»‹ç»äº†åœ¨OpenRLHFä¸­æ˜¯å¦‚ä½•å°†Rayå’ŒvLLMè¿›è¡Œç»“åˆäº†ï¼Œç›´æ¥å›é¡¾ `train_ppo_ray.py`ä»£ç ï¼š

```python
def train(...):
    ...
    # 1ã€åˆ›å»ºvLLM
    vllm_engines = None
    if ...:
        vllm_engines = create_vllm_engines(...)
```
ç¬¬ä¸€æ­¥ã€åˆ›å»ºvLLMï¼Œä¸Šé¢å·²ç»ä»‹ç»ä¸åšèµ˜è¿°
ç¬¬äºŒæ­¥ã€


## ä»£ç æµ‹è¯•


## æ€»ç»“

---
layout: mypost
title: Ê∑±ÂÖ•ÊµÖÂá∫‰∫ÜËß£ÁîüÊàêÊ®°Âûã-6ÔºöÂ∏∏Áî®Âü∫Á°ÄÊ®°Âûã‰∏é AdaptersÁ≠âËß£Êûê
categories: ÁîüÊàêÊ®°Âûã
extMath: true
images: true
address: ÈïøÊ≤ôüå∑
show_footer_image: true
tags:
- ÁîüÊàêÊ®°Âûã
- diffusion model
- ControlNet
- T2I-Adapter
- SD
- SDVL
show: true
description: Êú¨ÊñáÈáçÁÇπÂØπÊØîStable Diffusion SD 1.5‰∏éSDXLÂü∫Â∫ßÊ®°ÂûãÔºåÂàÜÊûêCLIPÁºñÁ†ÅÂô®Â∑ÆÂºÇÔºàSDXLÈááÁî®OpenCLIP-ViT/G‰∏éCLIP-ViT/LÊãºÊé•ÔºåÊñáÊú¨ÁêÜËß£ËÉΩÂäõÊõ¥Âº∫Ôºâ„ÄÅÂõæÂÉèËæìÂá∫Áª¥Â∫¶ÔºàSDXLÈªòËÆ§1024x1024Âπ∂‰ΩøÁî®refinerÊ®°ÂûãÔºâÂèäSDXLÂàÜËæ®Áéá‰∏éË£ÅÂâ™‰ºòÂåñÁ≠ñÁï•ÔºõÂêåÊó∂‰ªãÁªçAdapters‰∏≠ÁöÑControlNetÔºàÈÄöËøázero-convolutionÊåáÂØºËæìÂá∫ÔºâÂíåT2I-AdapterÔºàÁâπÂæÅÁõ∏Âä†ÊéßÂà∂ÁîüÊàêÔºâ„ÄÇ
---

## Stable DiffusionÁ≥ªÂàó
‰∏ªË¶Å‰ªãÁªçSD‰ª•ÂèäSDXL‰∏§Á±ªÊ®°ÂûãÔºå‰ΩÜÊòØSDËø≠‰ª£ÁâàÊú¨Êå∫Â§öÁöÑÔºà‰ªé1.2Âà∞3.5ÔºâÂõ†Ê≠§Êú¨Êñá‰∏ªË¶ÅÈáçÁÇπ‰ªãÁªçSD 1.5‰ª•ÂèäSDXL‰∏§‰∏™Âü∫Â∫ßÊ®°ÂûãÔºå‰ª•Âèä‰∏§ËÄÖ‰πãÈó¥ÁöÑÂØπÊØîÂ∑ÆÂºÇ„ÄÇ
### SDv1.5 vs SDXL[^1]
> **SDv1.5**: https://huggingface.co/stable-diffusion-v1-5/stable-diffusion-v1-5
> **SDXL**:https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0

‰∏§ËÄÖÊ®°ÂûãËØ¶ÁªÜÁöÑÊ®°ÂûãÁªìÊûÑÔºö[SDv1.5--SDXLÊ®°ÂûãÁªìÊûÑÂõæ](../Dio.drawio)ÔºåÂÖ∂‰∏≠ÂÖ∑‰ΩìÊ®°ÂûãÂèÇÊï∞ÁöÑÂØπÊØîÂ¶Ç‰∏ãÔºö
**1„ÄÅCLIPÁºñÁ†ÅÂô®Âå∫Âà´**Ôºö
Âú®SD1.5‰∏≠ÈÄâÊã©ÁöÑÊòØ**CLIP-ViT/L**ÔºàÂæóÂà∞ÁöÑÁª¥Â∫¶‰∏∫Ôºö768ÔºâËÄåÂú®SDXL‰∏≠ÈÄâÊã©ÁöÑÊòØ‰∏§‰∏™CLIPÊñáÊú¨ÁºñÁ†ÅÂô®Ôºö**OpenCLIP-ViT/G**ÔºàÂæóÂà∞ÁöÑÁª¥Â∫¶‰∏∫Ôºö1280Ôºâ‰ª•Âèä**CLIP-ViT/L**ÔºàÂæóÂà∞Áª¥Â∫¶‰∏∫Ôºö768ÔºâÂú®‰ª£Á†Å‰∏≠ÂØπ‰∫é‰∏§‰∏™ÊñáÊú¨ÈÄöËøáÁºñÁ†ÅÂô®Â§ÑÁêÜ‰πãÂêéSDXLÁõ¥Êé•ÈÄöËøácatÊñπÂºèÊãºÊé•Ôºö`prompt_embeds = torch.concat(prompt_embeds_list, dim=-1)` ‰πüÂ∞±ÊòØËØ¥ÊúÄÂêéÂæóÂà∞ÁöÑÁª¥Â∫¶‰∏∫Ôºö[..,..,1280+768]„ÄÇÊúÄÂêéÊïàÊûúÂæàÊòéÊòæÔºö**SDXLÂØπ‰∫éÊñáÊú¨ÁöÑÁêÜËß£ËÉΩÂäõÂ§ß‰∫éSD1.5**
**2„ÄÅÂõæÂÉèËæìÂá∫Áª¥Â∫¶Âå∫Âà´**Ôºö
ÂÜçSD1.5‰∏≠ÁöÑÈªòËÆ§ËæìÂá∫ÊòØÔºö512x512ËÄåÂÜçSDXL‰∏≠ÁöÑÈªòËÆ§ËæìÂá∫ÊòØÔºö1024x1024ÔºåÂ¶ÇÊûúÂ∏åÊúõÂ∞ÜSD1.5ÁîüÊàêÁöÑÂõæÂÉèÂ§ÑÁêÜ‰∏∫1024x1024ÂèØ‰ª•Áõ¥Êé•ÈÄöËøáË∂ÖÂàÜÁÆóÊ≥ïÊù•ËøõË°åÂ§ÑÁêÜÔºåÈô§Ê≠§‰πãÂ§ñÂú®SDXL‰∏≠Ëøò‰ºö‰ΩøÁî®‰∏Ä‰∏™refinerÊ®°ÂûãÔºàÂíåUnetÁöÑÁªìÊûÑÁõ∏‰ººÔºâÊù•Âº∫ÂåñbaseÊ®°ÂûãÔºàUnetÔºâÁîüÊàêÁöÑÊïàÊûú„ÄÇ
**3„ÄÅSDXLËÆ∫Êñá‰∏≠ÁöÑÊäÄÊúØÁªÜËäÇ**Ôºö
* 1„ÄÅ**ÂõæÂÉèÂàÜËæ®Áéá‰ºòÂåñÁ≠ñÁï•**„ÄÇ

Êï∞ÊçÆÈõÜ‰∏≠ÂõæÂÉèÁöÑÂ∞∫ÂØ∏ÂõæÂÉèÂà©Áî®ÁéáÈóÆÈ¢òÔºàÈÄâÊã©512x512ËàçÂºÉ256x256Â∞±‰ºöÂØºËá¥ÂõæÂÉèÂ§ßÈáèË¢´ËàçÂºÉÔºâÂ¶ÇÊûúÈÄöËøáË∂ÖÂàÜËæ®ÁéáÁÆóÊ≥ïÂ∞ÜÂõæÂÉèÂ∞±Ë°åÊâ©Â±ï‰ºöÊîæÂ§ß‰º™ÂΩ±ÔºåËøô‰∫õ‰º™ÂΩ±ÂèØËÉΩ‰ºöÊ≥ÑÊºèÂà∞ÊúÄÁªàÁöÑÊ®°ÂûãËæìÂá∫‰∏≠Ôºå‰æãÂ¶ÇÔºåÂØºËá¥Ê†∑Êú¨Ê®°Á≥ä„ÄÇÔºàThe second method, on the other hand, usually introduces upscaling artifacts which may leak into the final model outputs, causing, for example, blurry samples.Ôºâ‰ΩúËÄÖÂÅöÊ≥ïÊòØÔºö**ËÆ≠ÁªÉÈò∂ÊÆµ**Áõ¥Êé•Â∞ÜÂéüÂßãÂõæÂÉèÁöÑÂàÜËæ®Áéá $c=(h_{org},w_{org})$‰Ωú‰∏∫‰∏Ä‰∏™Êù°‰ª∂ÔºåÈÄöËøáÂÇÖÈáåÂè∂ÁâπÂæÅÁºñÁ†ÅËÄåÂêéÂä†ÂÖ•Âà∞time embedding‰∏≠Ôºå**Êé®ÁêÜÈò∂ÊÆµ**Áõ¥Êé•Â∞ÜÂàÜËæ®Áéá‰Ωú‰∏∫‰∏Ä‰∏™Êù°‰ª∂Â∞±Ë°åÂµåÂÖ•ÔºåËøõËÄåÂÆûÁé∞Ôºö**ÂΩìËæìÂÖ•‰ΩéÂàÜËæ®ÁéáÊù°‰ª∂Êó∂ÔºåÁîüÊàêÁöÑÂõæÂÉèËæÉÊ®°Á≥äÔºõÂú®‰∏çÊñ≠Â¢ûÂ§ßÂàÜËæ®ÁéáÊù°‰ª∂Êó∂ÔºåÁîüÊàêÁöÑÂõæÂÉèË¥®Èáè‰∏çÊñ≠ÊèêÂçá„ÄÇ**
![image.png](https://s2.loli.net/2025/07/09/pMcLmdHThu2CnNx.webp)

* 2„ÄÅ**ÂõæÂÉèË£ÅÂâ™‰ºòÂåñÁ≠ñÁï•**

Áõ¥Êé•Áªü‰∏ÄÈááÊ†∑Ë£ÅÂâ™ÂùêÊ†átopÂíåcleftÔºàÂàÜÂà´ÊåáÂÆö‰ªéÂ∑¶‰∏äËßíÊ≤øÈ´òÂ∫¶ÂíåÂÆΩÂ∫¶ËΩ¥Ë£ÅÂâ™ÁöÑÂÉèÁ¥†Êï∞ÈáèÁöÑÊï¥Êï∞ÔºâÔºåÂπ∂ÈÄöËøáÂÇÖÈáåÂè∂ÁâπÂæÅÂµåÂÖ•Â∞ÜÂÆÉ‰ª¨‰Ωú‰∏∫Ë∞ÉËäÇÂèÇÊï∞ËæìÂÖ•Ê®°ÂûãÔºåÁ±ª‰ºº‰∫é‰∏äÈù¢ÊèèËø∞ÁöÑÂ∞∫ÂØ∏Ë∞ÉËäÇ
Á¨¨1Ôºå2ÁÇπ‰ª£Á†Å‰∏≠ÁöÑÂ§ÑÁêÜÊñπÂºè‰∏∫Ôºö
```python
def _get_add_time_ids(
        self, original_size, crops_coords_top_left, target_size, dtype, text_encoder_projection_dim=None
    ):
    add_time_ids = list(original_size + crops_coords_top_left + target_size)

    passed_add_embed_dim = (
        self.unet.config.addition_time_embed_dim * len(add_time_ids) + text_encoder_projection_dim
    )
    expected_add_embed_dim = self.unet.add_embedding.linear_1.in_features
    ...
    add_time_ids = torch.tensor([add_time_ids], dtype=dtype)
    return add_time_ids
```

> **Êé®ËçêÈòÖËØª**Ôºö
> 1„ÄÅ[SDv1.5-SDXL-SD3ÁîüÊàêÊïàÊûúÂØπÊØî](https://www.magicflow.ai/showcase/sd3-sdxl-sd1.5)

## Adapters
> https://huggingface.co/docs/diffusers/tutorials/using_peft_for_inference

Ê≠§Á±ªÊñπÊ≥ïÊòØÂú®ÂÆåÂ§áÁöÑ DF ÊùÉÈáçÂü∫Á°Ä‰∏äÔºåÈ¢ùÂ§ñÊ∑ªÂä†‰∏Ä‰∏™‚ÄúÊèí‰ª∂‚ÄùÔºå‰øùÊåÅÂéüÊúâÊùÉÈáç‰∏çÂèò„ÄÇÊàëÂè™ÈúÄ‰øÆÊîπËøô‰∏™Êèí‰ª∂ÔºåÂ∞±ÂèØ‰ª•ËÆ©Ê®°ÂûãÁîüÊàê‰∏çÂêåÈ£éÊ†ºÁöÑÂõæÂÉè„ÄÇ‰∏ãÈù¢‰ªãÁªçÁöÑ ControlNet Âíå T2I-AdapterÔºåÂèØ‰ª•ÁêÜËß£‰∏∫Âú®ÂéüÂßãÊ®°Âûã‰πãÂ§ñÊñ∞Â¢û‰∏Ä‰∏™‚ÄúÁîüÊàêÊù°‰ª∂‚ÄùÔºåÈÄöËøá‰øÆÊîπËøô‰∏ÄÊù°‰ª∂Âç≥ÂèØÁÅµÊ¥ªÊéßÂà∂Ê®°ÂûãÁîüÊàêÂêÑÁßçÈ£éÊ†ºÊàñÊª°Ë∂≥‰∏çÂêåÈúÄÊ±ÇÁöÑÂõæÂÉè„ÄÇ

### ControlNet[^2]
> https://github.com/lllyasviel/ControlNet
> Âª∫ËÆÆÁõ¥Êé•ÈòÖËØªÔºö[https://github.com/lllyasviel/ControlNet/discussions/categories/announcements](https://github.com/lllyasviel/ControlNet/discussions/categories/announcements) Êù•‰∫ÜËß£Êõ¥Âä†Â§öÁªÜËäÇ

![](https://s2.loli.net/2025/07/09/Tfji2LMv15tgr6d.webp)

ControlNetÁöÑÂ§ÑÁêÜÊÄùË∑ØÂ∞±ÂæàÁÆÄÂçïÔºåÂÜçÂ∑¶Âõæ‰∏≠Ê®°ÂûãÁöÑÂ§ÑÁêÜËøáÁ®ãÂ∞±ÊòØÁõ¥Êé•ÈÄöËøáÔºö$y=f(x;\theta)$Êù•ÁîüÊàêÂõæÂÉèÔºå‰ΩÜÊòØÂú®ControlNetÈáåÈù¢‰ºöÂ∞ÜÊàë‰ª¨ÊúÄÂºÄÂßãÁöÑÁΩëÁªúÁªìÊûÑÂ§çÂà∂ÁÑ∂ÂêéÈÄöËøáÂú®ÂÖ∂ÂâçÂêéÂºïÂÖ•‰∏Ä‰∏™**zero-convolution**Â±ÇÊù•‚ÄúÊåáÂØº‚ÄùÔºà$Z$ÔºâÊ®°ÂûãÁöÑËæìÂá∫‰πüÂ∞±ÊòØËØ¥Â∞Ü‰∏äÈù¢ÁöÑÁîüÊàêËøáÁ®ãÂèò‰∏∫Ôºö$y=f(x;\theta)+Z(f(x+Z(c;\theta_{z_1});\theta);\theta_{Z_2})$„ÄÇÈÄöËøáÂÜªÁªìÊúÄÂàùÁöÑÊ®°ÂûãÁöÑÊùÉÈáç‰øùÊåÅ‰∏çÂèòÔºå‰øùÁïô‰∫ÜStable DiffusionÊ®°ÂûãÂéüÊú¨ÁöÑËÉΩÂäõÔºõ‰∏éÊ≠§ÂêåÊó∂Ôºå‰ΩøÁî®È¢ùÂ§ñÊï∞ÊçÆÂØπ‚ÄúÂèØËÆ≠ÁªÉ‚ÄùÂâØÊú¨ËøõË°åÂæÆË∞ÉÔºåÂ≠¶‰π†Êàë‰ª¨ÊÉ≥Ë¶ÅÊ∑ªÂä†ÁöÑÊù°‰ª∂„ÄÇÂõ†Ê≠§Âú®ÊúÄÂêéÊàë‰ª¨ÁöÑSDÊ®°Âûã‰∏≠Â∞±ÊòØÂ¶Ç‰∏ã‰∏Ä‰∏™ÁªìÊûÑÔºö

![](https://s2.loli.net/2025/07/09/uVNAEnleRMJ6p4v.webp)

Âú®ËÆ∫ÊñáÈáåÈù¢‰ΩúËÄÖÁªôÂá∫‰∏Ä‰∏™ÂÆûÈôÖÁöÑÊµãËØïÊïàÊûúÂèØ‰ª•ÂæàÂÆπÊòìÁêÜËß£ÈáåÈù¢Êù°‰ª∂cÔºàÊù°‰ª∂ ùëêÂ∞±ÊòØÊèê‰æõÁªôÊ®°ÂûãÁöÑÊòæÂºèÁªìÊûÑÂºïÂØº‰ø°ÊÅØÔºå**Áî®‰∫éÂú®ÁîüÊàêËøáÁ®ã‰∏≠Á≤æÁ°ÆÊéßÂà∂ÂõæÂÉèÁöÑÁ©∫Èó¥ÁªìÊûÑÊàñÂ∏ÉÂ±Ä**Ôºå‰∏ÄËà¨Êù•ËØ¥ÂèØ‰ª•ÊòØËçâÂõæ„ÄÅÂàÜÂâ≤ÂõæÁ≠âÔºâÂà∞Â∫ïÊòØ‰∏Ä‰∏™‰ªÄ‰πà‰∏úË•øÔºåÊØîÂ¶ÇËØ¥Â∞±ÊòØÁõ¥Êé•ÁªôÂá∫‰∏Ä‰∏™‚ÄúÁ∫øÁ®ø‚ÄùÁÑ∂ÂêéÊ®°ÂûãÊù•ËæìÂá∫ÂõæÂÉè„ÄÇ

![](https://s2.loli.net/2025/07/09/rkWH3o1MOaNs6pg.webp)

> **Ë°•ÂÖÖ-1**Ôºö‰∏∫‰ªÄ‰πà‰ΩøÁî®‰∏äÈù¢ËøôÁßçÁªìÊûÑ
> Âú®[github](https://github.com/lllyasviel/ControlNet/discussions/188)‰∏ä‰ΩúËÄÖËÆ®ËÆ∫‰∫Ü‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®‰∏äÈù¢ËøôÁßçÁªìÊûÑËÄåÈùûÁõ¥Êé•‰ΩøÁî®mlpÁ≠âÔºà‰ΩúËÄÖÁªôÂá∫‰∫ÜÂæàÂ§öÊµãËØïÂõæÂÉèÔºâÔºåÊúÄÂêéÊÄªÁªìÂ∞±ÊòØÔºö**ËøôÁßçÁªìÊûÑÂ•Ω**
> **Ë°•ÂÖÖ-2**Ôºö‰ΩøÁî®0Âç∑ÁßØÂ±Ç‰ºö‰∏ç‰ºöÂØºËá¥Ê®°ÂûãÊó†Ê≥ï‰ºòÂåñÈóÆÈ¢òÔºü
> ‰∏ç‰ºöÔºåÂõ†‰∏∫ÂØπ‰∫éÁ•ûÁªèÁΩëÁªúÁªìÊûÑÂ§ßÂ§öÈÉΩÊòØÔºö$y=wx+b$ËÆ°ÁÆóÊ¢ØÂ∫¶ËøáÁ®ã‰∏≠Âç≥‰Ωø $w=0$‰ΩÜÊòØÈáåÈù¢ÁöÑ $x‚â†0$Ê®°ÂûãÁöÑÂèÇÊï∞ËøòÊòØÂèØ‰ª•Ë¢´‰ºòÂåñÁöÑ

### T2I-Adapter[^3]
> https://github.com/TencentARC/T2I-Adapter

![image.png](https://s2.loli.net/2025/07/09/gZLDtFSGr25kCwa.webp)

T2IÁöÑÂ§ÑÁêÜÊÄùË∑Ø‰πüÊØîËæÉÁÆÄÂçïÔºàT2I-Adap 4 ter DetailsÈáåÈù¢ÂÖ∂ÂÆûÂ∞±ÂÜôÁöÑÂæàÊòéÁôΩ‰∫ÜÔºâÔºåÂØπ‰∫éËæìÂÖ•ÁöÑÊù°‰ª∂ÂõæÁâáÔºàÊØîÂ¶ÇËØ¥ËæπÁºòÂõæÂÉèÔºâ:512x512ÔºåÈ¶ñÂÖàÈÄöËøá pixel unshuffleËøõË°å‰∏ãÈááÊ†∑Â∞ÜÂõæÂÉèÂàÜËæ®ÁéáÊîπ‰∏∫Ôºö64x64ËÄåÂêéÈÄöËøá‰∏ÄÂ±ÇÂç∑ÁßØ+‰∏§Â±ÇÊÆãÂ∑ÆËøûÊé•ÔºåËæìÂá∫ÂæóÂà∞ÁâπÂæÅ $F_c$‰πãÂêéÂ∞ÜÂÖ∂‰∏éÂØπÂ∫îÁöÑencoderÁªìÊûÑËøõË°åÁõ∏Âä†Ôºö$F_{enc}+ F_c$ÔºåÂΩìÁÑ∂T2I‰πüÊîØÊåÅÂ§ö‰∏™Êù°‰ª∂ÔºàÁõ¥Êé•ÈÄöËøáÂä†ÊùÉÁªÑÂêàÂ∞±Ë°åÔºâ
### ÂÆûÈôÖ‰ª£Á†ÅÊìç‰Ωú
> Code: [https://github.com/shangxiaaabb/ProjectCode/tree/main/code/Python/DFModelCode/training_controlnet](https://github.com/shangxiaaabb/ProjectCode/tree/main/code/Python/DFModelCode/training_controlnet)

Big-Yellow-J.github.io/code/Python/DFModelCode/training_controlnet
## ÂèÇËÄÉ
[^1]:https://arxiv.org/pdf/2307.01952
[^2]:https://arxiv.org/pdf/2302.05543
[^3]:https://arxiv.org/pdf/2302.08453
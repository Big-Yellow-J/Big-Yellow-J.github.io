---
layout: mypost
title: æ·±å…¥æµ…å‡ºäº†è§£ç”Ÿæˆæ¨¡å‹-4ï¼šä¸€è‡´æ€§æ¨¡å‹ï¼ˆconsistency modelï¼‰
categories: ç”Ÿæˆæ¨¡å‹
extMath: true
images: true
address: æ­¦æ±‰ğŸ¯
show_footer_image: true
tags:
- consistency model
- ç”Ÿæˆæ¨¡å‹
- diffusion model
show: true
description: ä¸€è‡´æ€§æ¨¡å‹ï¼ˆconsistency modelï¼‰æ˜¯æ‰©æ•£æ¨¡å‹ï¼ˆDiffusion Modelsï¼‰çš„å›¾åƒç”ŸæˆåŠ é€Ÿæ–¹æ³•ï¼Œé€šè¿‡å°†éšæœºè¿‡ç¨‹è½¬åŒ–ä¸ºå¸¸å¾®åˆ†æ–¹ç¨‹ï¼ˆODEï¼‰ï¼Œå¼•å…¥Consistency
  Regularizationå®ç°ä¸€æ­¥æˆ–å°‘æ•°å‡ æ­¥ç”Ÿæˆã€‚LCM/LCM-Loraè¿›ä¸€æ­¥é€šè¿‡Skipping-Stepå’ŒClassifier-free guidanceï¼ˆCFGï¼‰ä¼˜åŒ–ï¼Œä»£ç å¯å‚è€ƒdiffusersåº“å®è·µã€‚
---

å‰é¢å·²ç»ä»‹ç»äº†[æ‰©æ•£æ¨¡å‹](https://www.big-yellow-j.top/posts/2025/05/19/DiffusionModel.html)ï¼Œåœ¨æœ€åçš„ç»“è®ºé‡Œé¢æåˆ°ä¸€ç‚¹ï¼šæ‰©æ•£æ¨¡å‹å¾€å¾€éœ€è¦å¤šæ­¥æ‰èƒ½ç”Ÿæˆè¾ƒä¸ºæ»¡æ„çš„å›¾åƒã€‚ä¸è¿‡ç°åœ¨æœ‰ä¸€ç§æ–°çš„æ–¹å¼æ¥åŠ é€Ÿï¼ˆæ—¨åœ¨é€šè¿‡å°‘æ•°è¿­ä»£æ­¥éª¤ï¼‰ç”Ÿæˆå›¾åƒï¼š**ä¸€è‡´æ€§æ¨¡å‹ï¼ˆconsistency modelï¼‰**ï¼Œå› æ­¤è¿™é‡Œä¸»è¦æ˜¯ä»‹ç»ä¸€è‡´æ€§æ¨¡å‹ï¼ˆconsistency modelï¼‰åŸºæœ¬åŸç†ä»¥åŠä»£ç å®è·µï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯æœ¬æ–‡ä¸ä¼šè¿‡å¤šè§£é‡Šæ•°å­¦åŸç†ï¼Œæ•°å­¦åŸç†æ¨å¯¼å¯ä»¥å‚è€ƒï¼š

<iframe src="//player.bilibili.com/player.html?isOutside=true&aid=113086069474472&bvid=BV1w1p3eHEtB&cid=28321842065&p=1" scrolling="no" border="0" frameborder="no" framespacing="=50" allowfullscreen="false"></iframe>

ä»‹ç»ä¸€è‡´æ€§æ¨¡å‹ä¹‹å‰éœ€è¦äº†è§£å‡ ä¸ªçŸ¥è¯†ï¼šåœ¨ä¼ ç»Ÿçš„æ‰©æ•£æ¨¡å‹ä¸­æ— è®ºæ˜¯åŠ å™ªè¿˜æ˜¯è§£å™ªè¿‡ç¨‹éƒ½æ˜¯éšæœºçš„ï¼Œåœ¨è®ºæ–‡[^4]ä¸­ï¼ˆä¹Ÿå°±æ˜¯CMä½œè€…å®‹åšå£«çš„å¦å¤–ä¸€ç¯‡è®ºæ–‡ï¼‰å°†è¿™ä¸ªéšæœºè¿‡ç¨‹ï¼ˆä¹Ÿå°±æ˜¯éšæœºå¾®åˆ†æ–¹ç¨‹SDEï¼‰è½¬åŒ–æˆâ€œå›ºå®šçš„â€è¿‡ç¨‹ï¼ˆä¹Ÿå°±æ˜¯å¸¸å¾®åˆ†æ–¹ç¨‹ODEï¼‰ï¼Œåªæœ‰è¿‡ç¨‹å¯æ§æ‰èƒ½ä¿è¯ä¸‹é¢å…¬å¼æˆç«‹ã€‚

![](https://s2.loli.net/2025/06/21/RxYJFlc3BUbntaE.webp)

## ä¸€è‡´æ€§æ¨¡å‹ï¼ˆConsistency Modelï¼‰
![](https://s2.loli.net/2025/06/21/HnPuMUNaSq18jQG.webp)
> å…¶ä¸­`ODE`ï¼ˆå¸¸å¾®åˆ†æ–¹ç¨‹ï¼‰ï¼Œåœ¨ä¼ ç»Ÿçš„æ‰©æ•£æ¨¡å‹ï¼ˆDiffusion Models, DMï¼‰ä¸­ï¼Œå‰å‘è¿‡ç¨‹æ˜¯ä»åŸå§‹å›¾åƒ $x_0$å¼€å§‹ï¼Œä¸æ–­æ·»åŠ å™ªå£°ï¼Œç»è¿‡ $T$æ­¥å¾—åˆ°é«˜æ–¯å™ªå£°å›¾åƒ $x_T$ã€‚åå‘è¿‡ç¨‹ï¼ˆå¦‚ DDPMï¼‰é€šå¸¸é€šè¿‡è®­ç»ƒä¸€ä¸ªé€æ­¥å»å™ªçš„æ¨¡å‹ï¼Œå°† $x_T$é€æ­¥è¿˜åŸä¸º $x_0$ ï¼Œæ¯ä¸€æ­¥ä¼°è®¡ä¸€ä¸ªä¸­é—´çŠ¶æ€ï¼Œå› æ­¤æ¨ç†æˆæœ¬é«˜ï¼ˆéœ€è¿­ä»£ T æ­¥ï¼‰ã€‚è€Œåœ¨ **Consistency Modelsï¼ˆCMï¼‰** ä¸­ï¼Œæ¨¡å‹è®­ç»ƒæ—¶å¼•å…¥äº† **Consistency Regularization**ï¼Œä½¿å¾—æ¨¡å‹åœ¨ä¸åŒçš„æ—¶é—´æ­¥ $t$éƒ½èƒ½ä¸€è‡´åœ°é¢„æµ‹å¹²å‡€å›¾åƒã€‚è¿™æ ·åœ¨æ¨ç†æ—¶ï¼Œæ— éœ€è¿­ä»£å¤šæ­¥ï¼Œè€Œæ˜¯å¯ä»¥é€šè¿‡ä¸€ä¸ªå•ä¸€å‡½æ•°$f(x ,t)$ ç›´æ¥å°†ä»»æ„å™ªå£°å›¾åƒ$x_t$ è¿˜åŸä¸ºç›®æ ‡å›¾åƒ$x_0$ ã€‚è¿™å¤§å¤§å‡å°‘äº†æ¨ç†æ—¶é—´ï¼Œå®ç°äº†ä¸€æ­¥ï¼ˆæˆ–å°‘æ•°å‡ æ­¥ï¼‰ç”Ÿæˆã€‚

ä¸€è‡´æ€§æ¨¡å‹ï¼ˆconsistency modelï¼‰åœ¨è®ºæ–‡[^1]é‡Œé¢ä¸»è¦æ˜¯é€šè¿‡ä½¿ç”¨å¸¸å¾®åˆ†æ–¹ç¨‹è§’åº¦å‡ºå‘è¿›è¡Œè§£é‡Šçš„ã€‚Consistency Model åœ¨ Diffusion Model çš„åŸºç¡€ä¸Šï¼Œæ–°å¢äº†ä¸€ä¸ªçº¦æŸï¼š**ä»æŸä¸ªæ ·æœ¬åˆ°æŸä¸ªå™ªå£°çš„åŠ å™ªè½¨è¿¹ä¸Šçš„æ¯ä¸€ä¸ªç‚¹ï¼Œéƒ½å¯ä»¥ç»è¿‡ä¸€ä¸ªå‡½æ•° $f$ æ˜ å°„ä¸ºè¿™æ¡è½¨è¿¹çš„èµ·ç‚¹**ï¼ˆä¹Ÿå°±æ˜¯é€šè¿‡æ‰©æ•£å¤„ç†çš„å›¾åƒåœ¨ä¸åŒçš„æ—¶é—´ $t$éƒ½å¯ä»¥ç›´æ¥è½¬åŒ–ä¸ºæœ€å¼€å§‹çš„å›¾åƒ $x_0$ï¼‰ï¼Œç”¨æ•°å­¦æè¿°å°±æ˜¯ï¼š$f:(x_t, t)\rightarrow x_\epsilon$ï¼Œæ¢è¨€ä¹‹å°±æ˜¯éœ€è¦æ»¡è¶³ï¼š $f(x_t,t)=f(x_{t^\prime},t^\prime)$ å…¶ä¸­ $t,t^\prime \in [\epsilon,T]$ï¼Œæ­£å¦‚è®ºæ–‡é‡Œé¢çš„å›¾ç‰‡æè¿°ï¼š
![](https://s2.loli.net/2025/06/21/cXk2KYJA78PbdIW.webp)

è¦æ»¡è¶³ä¸Šé¢çš„è®¡ç®—å…³ç³»ï¼Œä½œè€…åœ¨è®ºæ–‡é‡Œé¢å®šä¹‰å¦‚ä¸‹çš„ç­‰å¼å…³ç³»ï¼š

$$
f_\theta(x,t)=c_{skip}(t)x+ c_{out}(t)F_\theta(x,t)
$$

å…¶ä¸­ç­‰å¼éœ€è¦æ»¡è¶³ï¼š$c_{skip}(\epsilon)=1,c_{out}(\epsilon)=0$ ï¼ˆ$c_{skip}(t)=\frac{\sigma_{data}^2}{(t- \epsilon)^2+ \sigma_{data}^2}$ï¼Œ $c_{out}(t)=\frac{\sigma_{data}(t-\epsilon)}{\sqrt{\sigma_{data}^2+ t^2}}$ï¼‰ï¼Œéšç€è§£å™ªè¿‡ç¨‹ï¼ˆæ—¶é—´ä»ï¼š$T \rightarrow  \epsilon$ å…¶ä¸­ $c_{skip}$ çš„å€¼é€æ¸å¢å¤§ï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„è§£å™ªå›¾åƒå æ¯”æƒé‡å¢åŠ ï¼‰ï¼Œå…¶ä¸­æˆ‘çš„ $F_\theta$ å°±æ˜¯æˆ‘ä»¬çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼ˆæ¯”å¦‚Unetï¼‰ã€‚æ—¢ç„¶ä½¿ç”¨äº†ç¥ç»ç½‘ç»œé‚£ä¹ˆå¿…å®šå°±éœ€è¦è®¾è®¡ä¸€ä¸ªæŸå¤±å‡½æ•°ï¼Œåœ¨è®ºæ–‡é‡Œé¢ä½œè€…è®¾è®¡çš„æŸå¤±å‡½æ•°ä¸ºï¼š**ä¸¤ä¸ªæ—¶é—´æ­¥ä¹‹é—´ç”Ÿæˆå¾—åˆ°çš„å›¾åƒè·ç¦»**é€šè¿‡æœ€å°åŒ–è¿™ä¸ªå€¼ï¼ˆæ¯”å¦‚è¯´ $\Vert x_{t+1} - x_t \Vert_2$ï¼‰æ¥ä¼˜åŒ–æ¨¡å‹å‚æ•°ã€‚ä½œè€…å¯¹äºæ¨¡å‹è®­ç»ƒç»™å‡ºä¸¤ç§è®­ç»ƒæ–¹å¼

### ç›´æ¥é€šè¿‡è’¸é¦æ¨¡å‹è¿›è¡Œä¼˜åŒ–
é€šè¿‡ç›´æ¥è’¸é¦çš„æ–¹å¼å¯¹æ¨¡å‹å‚æ•°è¿›è¡Œä¼˜åŒ–ï¼Œå…¶ä¸­è®¾è®¡çš„æŸå¤±å‡½æ•°ä¸ºï¼š

$$
\mathcal{L}_{CD}^N(\boldsymbol{\theta},\boldsymbol{\theta}^-;\phi) = \mathbb{E}[\lambda(t_n)d(\boldsymbol{f}_{\boldsymbol{\theta}}(\mathbf{x}_{t_{n+1}},t_{n+1}),\boldsymbol{f}_{\boldsymbol{\theta}^-}(\hat{\mathbf{x}}_{t_n}^{\boldsymbol{\phi}},t_n))]
$$

å…¶ä¸­ $d$ä»£è¡¨è·ç¦»ï¼ˆæ¯”å¦‚$l_1$æˆ–è€… $l_2$ï¼‰å¯¹äºä¸Šé¢å…¬å¼ä¸­å‡ ä¸ªå‚æ•°ï¼š$\theta, \theta^-$ï¼Œå…¶ä¸­ $\hat{x}_{t_n}^\phi$ ä»£è¡¨çš„æ˜¯ä¸€ä¸ªé¢„è®­ç»ƒçš„ score modelã€‚è™½ç„¶åœ¨CMä¸­æŸå¤±å‡½æ•°è®¾è®¡ä¸Šä¸€ä¸‹å­åˆ3ä¸ªæ¨¡å‹ï¼Œä½†æ˜¯å®é™…è®­ç»ƒè¿‡ç¨‹ä¸­æ›´æ–°çš„åªæœ‰ä¸€ä¸ªå‚æ•°ï¼š$\theta$ã€‚å¦å¤–ä¸€ä¸ªå‚æ•°æ˜¯ç›´æ¥é€šè¿‡ï¼š$\theta^- \leftarrow \mu \theta^-+ (1-\mu \theta) $ é€šè¿‡æŒ‡æ•°æ»‘åŠ¨å¹³å‡æ–¹å¼è¿›è¡Œè®­ç»ƒã€‚è€Œå¦å¤–ä¸€ä¸ªå‚æ•° $\phi$æ˜¯ä¸€ä¸ªç¡®å®šçš„å‡½æ•°ç›´æ¥é€šè¿‡ODE solveræ¥è¿›è¡Œè®¡ç®—å¾—åˆ°ï¼Œæ¯”å¦‚åœ¨è®ºæ–‡[^5]çš„ä½¿ç”¨çš„æ¬§æ‹‰æ±‚è§£æ³•ï¼š

$$
\hat{x}_{t_n}^\phi= x_{t_{n+1}}- (t_n- t_{n+1})t_{n+1}\nabla_{x_{t_{n+1}}}\log p_{t_{n+1}}(x_{t_{n+1}})
$$

> æ¬§æ‹‰æ³•ï¼š $y_{n+1}= y_n+h*f(t_n, y_n)$  å…¶ä¸­hä»£è¡¨æ—¶é—´æ­¥é•¿ï¼Œfä»£è¡¨å½“å‰å¯¼æ•°ä¼°è®¡ã€‚ä¸è¿‡å€¼å¾—è¿›ä¸€æ­¥äº†è§£çš„æ˜¯ï¼Œåœ¨DLä¸­å¤§éƒ¨åˆ†å‡½æ•°éƒ½æ˜¯ç›´æ¥é€šè¿‡ç¥ç»ç½‘ç»œè¿›è¡Œâ€œä¼°ç®—çš„â€ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹äºä¸Šé¢çš„ $\nabla_{x_{t_{n+1}}}\log p_{t_{n+1}} \textcolor{red}{â‰ˆ} s_\theta(x_{t_{n+1}},t_{n+1})$ å…¶ä¸­ $s_\theta$ä»£è¡¨çš„æ˜¯è®­ç»ƒå¥½çš„å»å™ªç½‘ç»œã€‚

é‚£ä¹ˆè¿™æ ·ä¸€æ¥æ•´ä¸ªè¿‡ç¨‹å°±å˜æˆäº†ï¼š
![](https://s2.loli.net/2025/06/21/ZpA3D7iqJcI5KdV.webp)

å›é¡¾æ•´ä¸ªè¿‡ç¨‹ï¼ˆç›´æ¥å€Ÿé‰´ä¸Šé¢çš„æµç¨‹å›¾ï¼‰ï¼Œç®—æ³•æ¯”è¾ƒç®€å•ï¼ˆåªä¸è¿‡èƒŒåçš„æ•°å­¦åŸç†è›®å¤æ‚ï¼‰ï¼Œç®€å•æè¿°ä¸Šé¢è¿‡ç¨‹å°±æ˜¯ï¼šå¯¹äºè¾“å…¥å›¾ç‰‡é€šè¿‡åŠ å™ªå¤„ç†ä¹‹åå¾—åˆ°åŠ å™ªçš„å›¾åƒï¼ŒæŸå¤±å‡½æ•°è®¾è®¡å°±æ˜¯ç›´æ¥é€šè¿‡è®¡ç®—ç›¸é‚»çš„ä¸¤æ­¥ä¹‹é—´çš„â€œè·ç¦»â€æœ€å°ï¼Œå¯¹äº $x_{t_{n+1}}$ æˆ‘ä»¬æ˜¯å·²ç»çŸ¥é“çš„ï¼Œä½†æ˜¯å¯¹äºå½“å‰æ—¶é—´ $t_n$ æ˜¯æœªçŸ¥çš„ï¼Œå› æ­¤å¯ä»¥ç›´æ¥é€šè¿‡ODE solverçš„æ–¹å¼å»è¿›è¡Œä¼°è®¡ï¼Œè€Œåå†å»è®¡ç®—losså¹¶ä¸”æ›´æ–°å‚æ•°ï¼Œå¯¹äºstudentsæ¨¡å‹å‚æ•° $\theta$å°±å¯ä»¥ç›´æ¥é€šè¿‡è®¡ç®—æ¢¯åº¦è€Œåè¿›è¡Œæ›´æ–°å‚æ•°ï¼Œè€Œå¯¹äºæ•™å¸ˆæ¨¡å‹å‚æ•° $\theta^-$ å¯ä»¥ç›´æ¥å¯é€šè¿‡EMAè¿›è¡Œæ›´æ–°

### ç›´æ¥è®­ç»ƒæ¨¡å‹è¿›è¡Œä¼˜åŒ–
ç›´æ¥è®­ç»ƒæ¨¡å‹è¿›è¡Œä¼˜åŒ–ï¼Œå…¶ä¸­å…·ä½“çš„è¿‡ç¨‹ä¸ºï¼š
![](https://s2.loli.net/2025/06/21/Y8QCsmnaqiRlkbP.webp)

## LCM/LCM-Lora
æ½œåœ¨ä¸€è‡´æ€§æ¨¡å‹ï¼ˆLatent Consistency Modelï¼‰[^2]ä»¥åŠLCM-Lora[^6]ï¼ˆLCMçš„Loraä¼˜å¾®è°ƒï¼‰é€šè¿‡å†latent spaceä¸­ä½¿ç”¨ä¸€è‡´æ€§æ¨¡å‹ï¼ˆstable diffusion modelé€šè¿‡VAEå°†å›¾åƒè¿›è¡Œå‹ç¼©åˆ°latent sapceè€Œåé€šè¿‡DFæ¨¡å‹è®­ç»ƒå¹¶ä¸”æœ€åå†é€šè¿‡VAE decoderè¾“å‡ºï¼‰ï¼Œåœ¨LCMä¸­ä¸»è¦æå‡ºä¸¤ç‚¹ï¼š
1ã€**Skipping-Step**ï¼šå› ä¸ºåœ¨æœ€å¼€å§‹çš„CMä¸­è®¡ç®—ä¸¤ä¸ªç›¸é‚»çš„æ—¶é—´æ­¥ä¹‹é—´çš„lossç”±äºæ—¶é—´æ­¥è¿‡äºæ¥è¿‘ï¼Œå°±ä¼šå¯¼è‡´losså¾ˆå°ï¼Œå› æ­¤é€šè¿‡è·³æ­¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™æ ·losså°±ä¼šå˜æˆï¼š$d(f(x_{t_{n+\textcolor{red}{k}}}, t_{n+\textcolor{red}{k}}), f(x_{t_n}, t_n))$ã€‚
2ã€å¼•å…¥**Classifier-free guidance (CFG)** é‚£ä¹ˆæ•´ä¸ªlossè®¡ç®—å°±ä¼šå˜æˆï¼š$d(f(x_{t_{n+\textcolor{red}{k}}}, \textcolor{red}{w}+ \textcolor{red}{c}, t_{n+\textcolor{red}{k}}), f(x_{t_n}, \textcolor{red}{w}+ \textcolor{red}{c}+ t_n))$ï¼Œå…¬å¼ä¸­cä»£è¡¨æ–‡æœ¬ï¼Œå¯¹äºCFGè€Œè¨€å…¶å®å°±æ˜¯ä¸€ä¸ªæ”¹è¿›çš„ODE solverï¼ˆè§ä¸‹é¢ç®—æ³•æµç¨‹ä¸­çš„è“è‰²éƒ¨åˆ†ï¼‰

å¯¹äºLCDç®—æ³•æµç¨‹ï¼Œå…¶ä¸­è“è‰²éƒ¨åˆ†ä¸ºLCMæ‰€ä¿®æ”¹çš„å†…å®¹ï¼š
![GZ7hs3blVFiJpfN.webp](https://s2.loli.net/2025/06/21/bftKAHLBJW21QFv.webp)

å¯¹äºæœ€åå¾—åˆ°çš„å®éªŒç»“æœåˆ†æï¼š
* ä¸åŒçš„kå¯¹ç»“æœçš„å½±å“

![download.webp](https://s2.loli.net/2025/06/21/JsrT8CbifgUaxv1.webp)

åœ¨DPM-solver++å’ŒDPM-Solverä¸­åŸºæœ¬åªéœ€è¦ 2000 æ­¥è¿­ä»£ï¼ŒLCM 4 æ­¥é‡‡æ ·çš„ FID å°±å·²ç»åŸºæœ¬æ”¶æ•›äº†

* ä¸åŒçš„Guidance Scaleå¯¹ç»“æœçš„å½±å“

![](https://s2.loli.net/2025/06/21/Uz29VWDdXb7hYHx.webp)

LCM ä½œè€…ç”¨ä¸åŒ LCM çš„è¿­ä»£æ¬¡æ•°ä¸ä¸åŒ Guidance Scale åšäº†å¯¹æ¯”ã€‚å‘ç° $w$ å¢åŠ æœ‰åŠ©äºæå‡ CLIP Scoreï¼Œä½†æ˜¯æŸå¤±äº† FID æŒ‡æ ‡ï¼ˆå³å¤šæ ·æ€§ï¼‰çš„è¡¨ç°ã€‚å¦å¤–ï¼ŒLCM è¿­ä»£æ¬¡æ•°ä¸º 2ã€4ã€8 æ—¶ï¼ŒCLIP Score å’Œ FID ç›¸å·®éƒ½ä¸å¤§ï¼Œè¯´æ˜äº† LCM çš„è’¸é¦æ€§èƒ½ç¡®å®éå¸¸å¼ºæ‚ï¼Œä¸¤æ­¥å‰å‘çš„æ•ˆæœå¯èƒ½éƒ½è¶³å¤Ÿå¥½äº†ï¼Œåªæ˜¯ä¸€æ­¥å‰å‘çš„ç»“æœè¿˜å·®äº›ã€‚
**æ€»å¾—æ¥è¯´**ï¼Œåœ¨LCMä¸­ä¸»è¦æ˜¯åšäº†å¦‚ä¸‹å‡ ç‚¹æ”¹è¿›ï¼š1ã€ä½¿ç”¨skipping-stepæ¥â€œæ‹‰å¤§â€ç›¸é‚»ç‚¹ä¹‹é—´çš„è·ç¦»è®¡ç®—ï¼›2ã€æ”¹è¿›äº†ODE solverã€‚
## ä»£ç æ“ä½œ[^7]
> ç›´æ¥é˜…è¯»[æœ€åæ€»ç»“](#æ€»ç»“)

ç›´æ¥ä½¿ç”¨diffuseré‡Œé¢ç»™çš„[æ¡ˆä¾‹](https://github.com/huggingface/diffusers/tree/main/examples/consistency_distillation)ä½¿ç”¨LCM/LCM-loraï¼Œä»£ç åˆ†æå¦‚ä¸‹ï¼š
1ã€æ—¶é—´æ­¥å¤„ç†ä»¥åŠ $c_{skip}$ å’Œ $c_{out}$
åœ¨ä»£ç ä¸­å®ç°Skipping-Stepå› æ­¤åœ¨ä»£ç ä¸­å¤„ç†æ–¹æ³•ä¸ºï¼šé¦–å…ˆé€šè¿‡DDPMï¼ˆå› ä¸ºåœ¨ä»£ç ä¸­ä½¿ç”¨çš„æ•™å¸ˆæ¨¡å‹æ˜¯ï¼š`stable-diffusion-v1-5/stable-diffusion-v1-5` è€Œä»–ä½¿ç”¨çš„å°±æ˜¯DDPMæ–¹å¼ï¼‰è€Œåè®¡ç®—å¾—åˆ°topkï¼ˆ1000//30=33ï¼‰ï¼Œè€Œåé€šè¿‡æ„å»ºéšæœºç´¢å¼•ï¼ˆé€šè¿‡DDIMé‡‡æ ·æ­¥ï¼š50ï¼‰ä»DDIMçš„time stepsï¼ˆ`(np.arange(1, ddim_timesteps + 1) * step_ratio).round().astype(np.int64) - 1`ï¼‰ä¸­è¿›è¡Œç´¢å¼•ã€‚è€Œåè®¡ç®—è¾¹ç•Œç¼©æ”¾ï¼š$c_{skip}(t)=\frac{\sigma_{data}^2}{t^2+ \sigma_{data}^2}$ï¼Œ $c_{out}(t)=\frac{t}{\sqrt{\sigma_{data}^2+ t^2}}$

```python
noise_scheduler = DDPMScheduler.from_pretrained(args.pretrained_teacher_model, subfolder="scheduler", revision=args.teacher_revision)
...
topk = noise_scheduler.config.num_train_timesteps // args.num_ddim_timesteps
index = torch.randint(0, args.num_ddim_timesteps, (bsz,), device=latents.device).long()
start_timesteps = solver.ddim_timesteps[index]
timesteps = start_timesteps - topk
timesteps = torch.where(timesteps < 0, torch.zeros_like(timesteps), timesteps)

# 3. Get boundary scalings for start_timesteps and (end) timesteps.
c_skip_start, c_out_start = scalings_for_boundary_conditions(
    start_timesteps, timestep_scaling=args.timestep_scaling_factor
)
c_skip_start, c_out_start = [append_dims(x, latents.ndim) for x in [c_skip_start, c_out_start]]
c_skip, c_out = scalings_for_boundary_conditions(
    timesteps, timestep_scaling=args.timestep_scaling_factor
)
c_skip, c_out = [append_dims(x, latents.ndim) for x in [c_skip, c_out]]
```

2ã€åŠ å™ªã€æ¨¡å‹å¤„ç†
å›¾åƒé€šè¿‡VAEå¤„ç†ä¹‹åç„¶åä¼šç›´æ¥é€šè¿‡`noise_scheduler.add_noise`å¤„ç†ï¼Œæœ€åé€šè¿‡æ¨¡å‹é¢„æµ‹å¾—åˆ°`noise_pred`ï¼Œå› ä¸ºåŠ å™ªè¿‡ç¨‹æ˜¯ $z_t=\sqrt{\alpha_t}x_0+ \sqrt{1-\alpha_t}\epsilon$ é€šè¿‡æ¨¡å‹å¾—åˆ°äº† $z_t$å› æ­¤åæ¨ï¼ˆ`get_predicted_original_sample`ï¼‰å¾—åˆ°åŠ å™ªå‰å›¾åƒ $x_0$ï¼Œ**æœ€åçš„æ¨¡å‹é¢„æµ‹å°±æ˜¯**ï¼š$f_\theta(x,t)=c_{skip}(t)x+ c_{out}(t)F_\theta(x,t)$

```python
noise = torch.randn_like(latents)
noisy_model_input = noise_scheduler.add_noise(latents, noise, start_timesteps)

# 5. Sample a random guidance scale w from U[w_min, w_max] and embed it
w = (args.w_max - args.w_min) * torch.rand((bsz,)) + args.w_min
w_embedding = guidance_scale_embedding(w, embedding_dim=time_cond_proj_dim)
w = w.reshape(bsz, 1, 1, 1)
# Move to U-Net device and dtype
w = w.to(device=latents.device, dtype=latents.dtype)
w_embedding = w_embedding.to(device=latents.device, dtype=latents.dtype)

# 6. Prepare prompt embeds and unet_added_conditions
prompt_embeds = encoded_text.pop("prompt_embeds")

# 7. Get online LCM prediction on z_{t_{n + k}} (noisy_model_input), w, c, t_{n + k} (start_timesteps)
noise_pred = unet(
    noisy_model_input,
    start_timesteps,
    timestep_cond=w_embedding,
    encoder_hidden_states=prompt_embeds.float(),
    added_cond_kwargs=encoded_text,
).sample

pred_x_0 = get_predicted_original_sample(
    noise_pred,
    start_timesteps,
    noisy_model_input,
    noise_scheduler.config.prediction_type,
    alpha_schedule,
    sigma_schedule,
)

model_pred = c_skip_start * noisy_model_input + c_out_start * pred_x_0
```

3ã€è®¡ç®—CFGã€è®¡ç®—loss
å› ä¸ºLCMæ˜¯ä¸€ä¸ªæ–‡æœ¬å¼•å¯¼çš„æ¨¡å‹ï¼Œå› æ­¤åœ¨CFGè®¡ç®—ä¸­ï¼š
![image.png](https://s2.loli.net/2025/06/25/kajBsrchNvH7Z9b.webp)

å…¶ä¸­å°±å­˜åœ¨è®¡ç®—æœ‰æ¡ä»¶æ–‡æœ¬$c$ å’Œæ— æ¡ä»¶æ–‡æœ¬ $\emptyset$ï¼ˆç›´æ¥ç”¨ç©ºæ–‡æœ¬`uncond_input_ids = tokenizer([""] * args.train_batch_size, return_tensors="pt", padding="max_length", max_length=77).input_ids.to(accelerator.device)uncond_prompt_embeds = text_encoder(uncond_input_ids)[0]`è¿›è¡Œè¡¨ç¤ºå³å¯ï¼‰[ä»£ç ](https://github.com/huggingface/diffusers/blob/80f27d7e8db9a6d9a79a320171446963660d8cdf/examples/consistency_distillation/train_lcm_distill_sdxl_wds.py#L1363)ã€‚æœ€åè®¡ç®—losså€¼ï¼Œæ›´æ–°å‚æ•°å¹¶ä¸”é€šè¿‡EMAæ›´æ–°æ•™å¸ˆæ¨¡å‹å‚æ•°ï¼š

```python
with torch.no_grad():
    if torch.backends.mps.is_available():
        autocast_ctx = nullcontext()
    else:
        autocast_ctx = torch.autocast(accelerator.device.type, dtype=weight_dtype)

    with autocast_ctx:
        target_noise_pred = target_unet(
            x_prev.float(),
            timesteps,
            timestep_cond=w_embedding,
            encoder_hidden_states=prompt_embeds.float(),
        ).sample
    pred_x_0 = get_predicted_original_sample(
        target_noise_pred,
        timesteps,
        x_prev,
        noise_scheduler.config.prediction_type,
        alpha_schedule,
        sigma_schedule,
    )
    target = c_skip * x_prev + c_out * pred_x_0

# 10. Calculate loss
if args.loss_type == "l2":
    loss = F.mse_loss(model_pred.float(), target.float(), reduction="mean")
elif args.loss_type == "huber":
    loss = torch.mean(
        torch.sqrt((model_pred.float() - target.float()) ** 2 + args.huber_c**2) - args.huber_c
    )
```

## æ€»ç»“
æ€»çš„æ¥è¯´consistency modelä½œä¸ºä¸€ç§diffusion modelç”Ÿæˆï¼ˆåŒºåˆ«ä¸DDPM/DDIMï¼‰åŠ é€Ÿæ“ä½œï¼Œåœ¨ç†è®ºä¸Šé¦–å…ˆ**å°†éšæœºç”Ÿæˆè¿‡ç¨‹å˜æˆâ€œç¡®å®šâ€è¿‡ç¨‹ï¼Œè¿™æ ·ä¸€æ¥ç”Ÿæˆå°±æ˜¯ç¡®å®šçš„**ï¼Œä» $T\rightarrow t_0$ æ‰€æœ‰çš„ç‚¹éƒ½åœ¨â€œä¸€æ¡çº¿â€ä¸Šç­‰å¼ $f(x_t,t)=f(x_{t^\prime},t^\prime)$ å…¶ä¸­ $t,t^\prime \in [\epsilon,T]$ æˆç«‹é‚£ä¹ˆå°±ä¿è¯äº†æ¨¡å‹ä¸éœ€è¦å†å»ä¸æ–­ä¾é  $t+1$ ç”Ÿæˆå†…å®¹å»æ¨æ–­ $t$æ—¶åˆ»å†…å®¹ï¼ˆå…·ä½“å¯ä»¥å‚è€ƒç®—æ³•æµç¨‹å›¾ï¼‰ã€‚è€Œåç»­çš„LCM/LCM-Lora/TCD[^3]åˆ™æ˜¯åŸºäºCMçš„åŸç†è¿›è¡Œæ”¹è¿›ï¼Œå›é¡¾ä¸€ä¸‹LCMçš„è¿‡ç¨‹ï¼Œç†è§£ä»£ç ï¼ˆå‚è€ƒHuggingfaceï¼‰æ“ä½œï¼š
![GZ7hs3blVFiJpfN.webp](https://s2.loli.net/2025/06/21/bftKAHLBJW21QFv.webp)

ï¼ˆLCMè’¸é¦ï¼‰è®­ç»ƒè¿‡ç¨‹ä¸­ä¸»è¦ä½¿ç”¨äº†3ä¸ªæ¨¡å‹ï¼š1ã€`teacher_model`ï¼›2ã€`unet`ï¼›3ã€`student_model`ã€‚å…¶ä¸­åé¢ä¸¤ä¸ªæ¨¡å‹æ˜¯ç›¸åŒçš„ï¼Œç¬¬ä¸€ä¸ªæ¨¡å‹å¯ä»¥ç›´æ¥ä½¿ç”¨è®­ç»ƒå¥½çš„SDæ¨¡å‹ã€‚
1ã€é¦–å…ˆæ˜¯æ„å»ºè·³æ­¥è¿­ä»£è¿‡ç¨‹ï¼Œè€Œåå»è®¡ç®—ï¼ˆå…¬å¼-1ï¼‰ $c_{skip}$å’Œ $c_{out}$ä»¥åŠï¼š$f_\theta(x,t)=c_{skip}(t)x+ c_{out}(t)F_\theta(x,t)$ å¯¹äºå…¶ä¸­çš„$x$ ä»¥åŠ $F_\theta$ ï¼ˆä»£ç ä¸­ï¼‰åˆ†åˆ«è¡¨ç¤ºçš„æ˜¯$t$æ—¶åˆ» æ¨¡å‹é¢„æµ‹çš„è¾“å‡ºå’Œ $t-1$æ—¶åˆ»çš„å™ªå£°å›¾åƒï¼ˆåŠ å™ªåæ¨å¯ä»¥ç›´æ¥è®¡ç®—å‡ºæ¥ï¼‰è¿™æ ·ä¸€æ¥å°±å¾—åˆ°ï¼ˆ `unet`æ¨¡å‹è®¡ç®— ï¼‰ï¼š`model_pred`ï¼ˆå¯¹åº”å…¬å¼ä¸­çš„ï¼š$f_\theta(z_{t_{n+k}},w,c,t_{n+k})$ï¼‰
2ã€å¯¹äº**ODE solverè®¡ç®—**å°±å’Œå…¬å¼-1è®¡ç®—è¿‡ç¨‹ç›¸ä¼¼ï¼Œåªä¸è¿‡éœ€è¦åŒºåˆ†æœ‰æ–‡æœ¬ç¼–ç å’Œæ²¡æœ‰æ–‡æœ¬ç¼–ç ä¸¤ç§ï¼Œæœ€åå¾—åˆ°ï¼ˆè¿™ä¸ªè¿‡ç¨‹é€šè¿‡æ•™å¸ˆæ¨¡å‹ `teacher_model` å¤„ç†ï¼‰`pred_x0 = cond_pred_x0 + w * (cond_pred_x0 - uncond_pred_x0)` ä»¥åŠ `pred_noise = cond_pred_noise + w * (cond_pred_noise - uncond_pred_noise)` è€Œåå†é€šè¿‡æ‰©æ•£è§£å™ªè¿‡ç¨‹å¾—åˆ°$t$æ—¶åˆ»çš„ï¼ˆ**ODE Solverç»“æœ**ï¼‰ï¼š `x_prev`ï¼ˆå¯¹åº”å…¬å¼ä¸­çš„ï¼š$z_{t_n}^{\Psi,w}$ï¼‰
3ã€è®¡ç®—lossé€šè¿‡`student_model`å¤„ç† `x_prev`è€Œååæ¨å¾—åˆ° `pred_x_0`å†å»è®¡ç®—$f_\theta(x,t)=c_{skip}(t)x+ c_{out}(t)F_\theta(x,t)$ï¼ˆ`c_skip * x_prev + c_out * pred_x_0`ï¼‰å¾—åˆ°targetã€‚æœ€åå»è®¡ç®—model_predå’Œ targetçš„losså€¼ï¼Œè€Œåå»é€šè¿‡EMAæ›´æ–° `student_model`å‚æ•°ï¼ˆé€šè¿‡`unet`æ¥æ›´æ–°ä»–çš„å‚æ•°ï¼‰

## å‚è€ƒ
[^1]:https://arxiv.org/abs/2303.01469
[^2]:https://arxiv.org/abs/2310.04378
[^3]:https://arxiv.org/abs/2402.19159
[^4]:https://arxiv.org/pdf/2011.13456
[^5]:https://arxiv.org/pdf/2406.14548v2
[^6]:https://arxiv.org/abs/2311.05556
[^7]:https://github.com/huggingface/diffusers/tree/main/examples/consistency_distillation